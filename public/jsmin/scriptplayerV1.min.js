document.addEventListener("DOMContentLoaded",(function(){const e=io();let o=null,t=null,n="fid",a=null,l=null,r={},s={},c={};const i={note:"home setting",temp:"game.main",partialName:"game-links",ob:l,tempType:"home",sub:null},m=window.getQueries(window.location.href),d="true"===m.fake,g=e=>{$.isEmptyObject(r)?(r=e,window.gameShare(r)):Object.assign(r,e)},p=()=>{let e=null;return localStorage.getItem(t)&&(e=localStorage.getItem(t)),m.hasOwnProperty(n)?m[n]:d?"":e},u=()=>{e.emit("getGameCount",(l=>{console.log(`getGameCount callback: ${l}`),0===l?Date.now()-a<1e4?setTimeout(u,500):console.log("giving up looking for games"):(()=>{let a=m.hasOwnProperty(n)?m[n]:d?"":localStorage.getItem(t);const l={game:o,player:a,fake:d,socketID:e.id};window.socketShare(e),e.emit("registerPlayer",l,(e=>{if(console.log("the callback"),e){console.log("registerwithGame",e);let o=e.id;e.game&&(e.game=JSON.parse(e.game),g(e.game),b(r)),o.indexOf("f",0)>-1&&(t+=o),localStorage.setItem(t,o),e.renderState&&(e.renderState.source="registerPlayer event",P(e.renderState));let n=window.location.hash;if(n){let e={temptype:"sub"};if(/\d/.test(n)){const o=parseInt(n.match(/\d+/)[0]);e.ob=Object.assign({},r.persistentData.teams[`t${o}`]),delete e.ob.game,n=n.replace(/\d/g,"")}e.temp=`game.${n.replace("#","")}`,P(e)}j((()=>{r.round>0&&k(r.round)}))}}))})()}))},w=e=>{o=window.location.pathname,t=e,a=Date.now(),u()},b=e=>{(e=>{const o=p(),t=e.teams;let n=-1;for(let e=0;e<t.length;e++)if(t[e].includes(o)){n=e;break}e.persistentData.teams[`t${n}`]})(e);l=e.playersFull[p()],window.playerShare(l)},f=()=>{const o={id:p(),sock:e.id,stored:"null"};var t,n;l&&(o.stored=l.socketID),t="playerID",n=o,$(".overlay")&&$(".overlay").remove(),window.getTemplate("overlay",{},(e=>{$("body").append(e),window.renderTemplate("overlay",t,n,(()=>{$(".overlay").fadeIn(300).delay(2e3).fadeOut(1e3)}))}))},y=e=>{const o=`${t}-roundState`;localStorage.setItem(o,e)},h=async()=>{const o=$(".yourmove-btn");o.length>0&&(o.removeClass("disabled"),o.off("click").on("click",(async()=>{y(!0);await new Promise(((o,t)=>{e.emit("getRenderState",{game:r,playerID:l.id},(e=>{console.log("game",r),console.log("renderState",e),o(e),P(e),j()}))}))})),$("html, body").animate({scrollTop:o.offset().top},300,(()=>{o.data("flashed")||(o.data("flashed",!0),o.fadeOut(100).fadeIn(200).fadeOut(100).fadeIn(200).fadeOut(100).fadeIn(200,(()=>{o.data("flashed",!1)})))})))},k=async e=>{console.log("onStartRound, ob:",e),e.game&&g(e.game);const o="object"==typeof e?e.val:e;if(round=r.persistentData.rounds[o],-1===o&&(P({temp:"game.main",partialName:"game-links"}),j()),round&&(console.log("yep, round is OK"),round.type===l.teamObj.type)){console.log("conditions met");const e=await thisRoundScored();console.log("hmmmm",e),e.hasScore||(console.log("activate"),h())}},S=async()=>{const o=$(".home_btn");if($.isEmptyObject(c)){const o=await new Promise(((o,t)=>{e.emit("getRenderState",{game:r,playerID:l.id},(e=>{o(e)}))}));o.source="getRenderState event",c=o}o.off("click"),o.on("click",(async()=>{O(),D(),y(!1),T(),j();if(r.persistentData.rounds[r.round]){(await thisRoundScored()).hasScore||h()}}))},O=e=>{if(e=Boolean(e)?`#${e}`:"",!window.location.hash.includes(e)||""===e){let o=window.location.href;o=o.replace(window.location.hash,""),o+=e,window.history.replaceState({},"",o)}},v=()=>{S();$("a").off("click").on("click",(function(){const e=$(this).attr("id").split("_")[1],o=Object.assign({},r.persistentData.teams[`t${e}`]);o.game={},delete o.game,O(`connecton.team${e}`),P({temp:"game.connecton.team",ob:o}),j((()=>{console.log("ok, we can set up the button now")}))}))},I=e=>{switch(e){case"main":(()=>{const e=$(".link_main"),o=($("#link_resources"),$("#link_global")),t=$("#link_connecton");e.off("click"),o.on("click",(()=>{O("global"),P({temp:"game.global",sub:null,tempType:"sub",ob:{hasContent:!0}}),T(),j()})),t.on("click",(()=>{O("connecton"),P({temp:"game.connecton",sub:null,tempType:"sub"}),T(),j()}))})();break;case"global":S();break;case"connecton":v();break;case"allocation":window.setupAllocationControl();break;case"vote":window.setupVoteControl();break;case"connecton.team":$("#connecton_btn").off("click").on("click",(()=>{P({temp:"game.connecton",ob:{}}),O("reset"),O("connecton"),j()}));break;default:console.warn(`no controls defined for ${e}`)}},P=e=>{if(e){console.log("updating the renderState"),console.log(e),console.log(s);const o=[];Object.assign(s,e);for(let e in s)null===s[e]&&(o.push(e),delete s[e]);const t=Object.assign({},s);t.msg&&console.log(t.msg),delete s.note}},D=()=>{i.ob=l,P(i)},T=()=>{$("html, body").animate({scrollTop:0},300)},j=e=>{if("object"==typeof s){const o="game.",n=s.hasOwnProperty("targ")?s.targ:"insertion",a=s.hasOwnProperty("ob")?s.ob:{};a.game=r,s.hasOwnProperty("partialName")&&(a.partialName=s.partialName),s.tempType&&"interaction"===s.tempType&&((()=>{const e=`${t}-roundState`;let o=localStorage.getItem(e);return o=procVal(o),o})()||D()),console.log("renderState",s);const l=s.temp.replace(o,"");delete a.game.playersFull,renderTemplate(n,s.temp,a,(()=>{I(l),s.hasOwnProperty("sub")?console.warn('"sub" functionality removed 20240416'):e&&e()}))}else console.warn("rendering not possible; renderState undefined")},R=document.getElementById("insertion");new MutationObserver(((e,o)=>{e.forEach((e=>{"childList"===e.type&&$(".home_btn").length>0&&S()}))})).observe(R,{childList:!0}),e.on("gameUpdate",(e=>{g(e),b(r),P({source:"gameUpdate event",temp:"game.main",ob:l}),j()})),e.on("test",(()=>{console.log("testing")})),e.on("playerConnect",(e=>{w(e)})),e.on("resetPlayer",(()=>{localStorage.clear(),P({temp:"game.intro"}),j()})),e.on("teamsAssigned",(e=>{(e=>{g(e),b(e),P({temp:"game.main",ob:l,partialName:"game-links"}),j()})(e)})),e.on("identifyPlayer",(()=>{f()})),e.on("identifySinglePlayer",(e=>{console.log(`id me: ${e}, ${l.id}`),e===l.id&&f()})),e.on("gameOver",(()=>{console.log("gameOver heard"),console.log("onGameEnd"),localStorage.clear(),P({temp:"game.gameover",ob:{}}),j()})),e.on("renderPlayer",(e=>{const o=e.hasOwnProperty(o)?e.ob:{},t=e.temp;P({temp:t,ob:o}),e.hasOwnProperty("targ")&&(s.targ=e.targ),j()})),e.on("forceRefresh",(()=>{window.location.reload()})),e.on("startRound",(e=>{console.log("startRound heard, ob:",e),k(e)})),e.on("waitForGame",(()=>{})),renderTemplate=window.renderTemplate,procVal=window.procVal,window.showGame=()=>r}));
