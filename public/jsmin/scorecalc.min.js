document.addEventListener("DOMContentLoaded",(function(){let t=null,l=null;const e=[{id:0,title:"gov"},{id:1,title:"ICM"},{id:2,title:"WEB"},{id:3,title:"CSO"},{id:4,title:"SME"}];let o=null,n=[],a=[],s=[],r=0;const i=(t,l)=>{const e=l||(()=>{let t=null;return s.length>0?t=s:o&&(n=o.scores,s=_(),t=s),t})();let a=[];return e&&(a="string"==typeof e[0]?e.filter((l=>parseInt(l.split("_")[0])===parseInt(t))):e.filter((l=>l.round===parseInt(t)))),a},c=(t,l)=>{const e=l||s;let o=[];return o="string"==typeof e[0]?e.filter((l=>parseInt(l.split("_")[1])===parseInt(t))):e.filter((l=>l.src===parseInt(t))),o},d=(t,l)=>{const e=l||s;let o=[];return o="string"==typeof e[0]?e.filter((l=>parseInt(l.split("_")[2])===parseInt(t))):e.filter((l=>l.dest===parseInt(t))),o},p=t=>{let l=0;return t.forEach((t=>{const e="string"==typeof t?parseInt(t.split("_")[3]):t.val;l+=isNaN(e)?0:e})),l},u=t=>void 0===t?0:"string"==typeof t?parseInt(t.split("_")[3]):t.val,h=()=>{const t={},l=p,o=d,n=c,a=i,s=u;let r=new Array,h=new Array(5).fill(0);for(let i=0;i<5;i++){const c=o(i,a(1))[0],d=o(i,a(3))[0],p=l(o(i,a(4))),u=l(o(i,a(3)))+l(o(i,a(4))),v=o(i,n(5,a(2)))[0],f=o(i,n(5,a(2))),$=l(f),g=$/f.length,m=(f.filter((t=>0!==t.val)).length,o(i,n(6,a(2)))[0]),_=o(i,n(6,a(2))),w=l(_),b=_.length>0?w/_.length:0,C=(_.filter((t=>0!==t.val)).length,g+b),A=window.roundNumber(g+b,2),S=window.roundNumber(s(c)*C,2),T=o(i,a(4)),k=[],y=o(i,n(5,a(5)))[0],I=o(i,n(5,a(5))),N=l(I),E=N/I.length,P=(I.filter((t=>0!==t.val)).length,o(i,n(6,a(5)))[0]),D=o(i,n(6,a(5))),O=l(D),j=O/D.length,V=(D.filter((t=>0!==t.val)).length,window.roundNumber(E+j,2)),M=(l(o(i,a(3)))+l(o(i,a(4))))*l(o(i,a(5)));for(let t=0;t<5;t++){const l=o(i,a(4)),e=n(t,o(i,T)),c=e.length?e[0]:"-";k.push(c);const d=s(n(t,l)[0])/u*M;r.push({sh:i===t?0:d}),isNaN(d)||(h[i]+=d)}const U=l(n(i,a(1)));t[`r${i}`]={t:e[i].title,a1:c,collTotal:p,collScores:k,allCollTotal:u,pv1_1:v,pv1_2:m,pv1_1AvAll:window.roundNumber(g,2),pv1_2AvAll:window.roundNumber(b,2),pvt1:A,total2030:S,a2:d,pv2_1:y,pv2_2:P,pv2_1AvAll:window.roundNumber(E,2),pv2_2AvAll:window.roundNumber(j,2),pvt2:V,allCollPV:M,shTotal:h,shArray:[],teamExpR1:U}}return Object.values(t).forEach(((t,l)=>{for(let e=0;e<5;e++){const o=r[5*e+l].sh;t.shArray.push(o)}t.shTotal=t.shArray.reduce(((t,l)=>t+(isNaN(l)?0:l)),0),t.scorePlusShare=t.shTotal+t.allCollPV,t.grandTotal=t.scorePlusShare+t.total2030})),t},v=t=>{if($(".input").off("click"),$("#all").html(t?"Full Edit Mode":"Single Score Edit Mode"),t)return $("#send").hide(),$("#reset").hide(),void $(".input").addClass("notclickable");$("#send").show(),$("#reset").show()},f=(t,l)=>{"td"===(t.is("input")?"input":"td")?t.html(l):t.val(l),t.data("scorePacket",l)},g=()=>{const t=h(),l=(()=>{const t=$(".inputs"),l={};return t.each(((t,e)=>{const o={},n=$(e);o.a1=$(n.find(".a1")),o.pv1_1=$(n.find(".pv_1_1")),o.pv1_2=$(n.find(".pv_1_2")),o.pvt1=$(n.find(".pvt1")),o.total2030=$(n.find(".2030total")),o.a2=$(n.find(".a2")),o.c=n.find(".c"),o.totalColl=$(n.find(".ctotal")),o.allCollTotal=$(n.find(".allCollTotal")),o.pv2_1=$(n.find(".pv_2_1")),o.pv2_2=$(n.find(".pv_2_2")),o.pvt2=$(n.find(".pvt2")),o.allCollPV=$(n.find(".allCollPV")),o.shTotal=$(n.find(".shTotal")),o.scoreShare=$(n.find(".scoreShare")),o.total2040=$(n.find(".2040total")),o.sh=n.find(".sval"),l[`r${t}`]=o})),l})();for(let t in l)for(let e in l[t])l[t][e].children().length>0&&!l[t][e].hasClass("res")&&(l[t][e]=l[t][e].find("input"));Object.values(l).forEach(((l,e)=>{const o=Object.values(t)[e];f(l.a1,u(o.a1)),f(l.pv1_1,o.pv1_1AvAll),f(l.pv1_2,o.pv1_2AvAll),f(l.pvt1,o.pvt1),f(l.total2030,o.total2030),l.c.each(((t,l)=>{f($(l),e===t?"":u(o.collScores[t])),$(l).removeClass("blank"),e===t&&$(l).attr("id")&&($(l).addClass("blank"),$(l).removeClass("input"))})),f(l.a2,u(o.a2)),f(l.totalColl,o.collTotal),f(l.allCollTotal,o.allCollTotal),f(l.pv2_1,o.pv2_1AvAll),f(l.pv2_2,o.pv2_2AvAll),f(l.pvt2,o.pvt2),f(l.allCollPV,o.allCollPV),l.sh.each(((t,l)=>{f($(l),e===t?"":o.shArray[t]),$(l).removeClass("blank"),e===t&&$(l).addClass("blank")})),f(l.shTotal,o.shTotal),f(l.scoreShare,o.scorePlusShare),f(l.total2040,o.grandTotal)})),v(0===r)},m=()=>{g()},_=()=>{const t=["round","src","dest","val","client"],l=[];return n.forEach(((e,o)=>{const n=e.split("_"),a={};n.forEach(((l,e)=>{a[t[e]]=parseInt(l)})),l.push(a)})),l},w=()=>{n=a.slice(),s=_(),m()},b=()=>{const t=$(".clickable").length>0;r=t?1:0;t&&(a=n.slice(),setTimeout((()=>{}),500)),$("td.input").each((function(){const t=$(this);if(t.find("input").length>0){const l=t.find("input").val();t.html(l),t.addClass("clickable")}else{const l=t.text().trim();t.html(`<input type="number" value="${l}">`),t.removeClass("clickable"),t.on("change",(()=>{n=A(),s=_(),m()}))}})),v(!t)},C=t=>{t?(o=t,t.scores.sort().toString()!==n.sort().toString()&&(n=t.scores,s=_()),m()):console.log("no game found - check that the dashboard is running")},A=()=>{const t=$(".input"),l=[];return t.each(((t,e)=>{const o=$(e).find("input").val()||0,n=$(e).attr("id").replace("_v_",`_${o}_`).split("_").slice(1).join("_");console.log($(e).attr("id"),n),l.push(n)})),l},S=async()=>{const t={},e=window.prompt("enter the admin password"),n=$("#gameID");t.pw=e,t.scores=A(),o?t.gameID=`game-${o.uniqueID}`:n.val()&&(t.gameID=`game-${n.val()}`),l.emit("sendScores",t,(t=>{}))},T=t=>{C(t)},k=t=>{C(t)};window.renderScoreboard=(n,a,s)=>{(()=>{if(o){const t=o.persistentData.teamsArray;e.forEach(((l,e)=>l.displayColour=t[e].displayColour))}else console.warn("expandTeams cannot complete; no game found")})();const r=a||"dev_scoretest";window.renderTemplate(n,r,{teams:e},(()=>{$("#reset").off("click").on("click",w),$("#send").off("click").on("click",S),$("#all").off("click").on("click",b);$(".inputs").each(((t,l)=>{$(l).find(".ci").each(((l,e)=>{t===l&&($(e).attr("disabled",!0),$(e).css({"background-color":"#767676"}),$(e).val(""))}))})),l&&l.emit("getGame",t,(t=>{C(t)})),s&&s()}))},window.initScoreboard=(e,n,a)=>{void 0===n?console.log("client ID must be provided as second arg in initScoreboard"):(t=e.replace("/game-",""),t&&(l=io("",{query:{role:`scoretest.${n}`,id:t}}),l.on("gameUpdate",(t=>{T(window.clone(Object.assign({method:"gameUpdate"},t)))})),l.on("scoresUpdate",(t=>{k(window.clone(Object.assign({method:"gameUpdate"},t)))}))),a&&(o=a))},window.getScoresSummary=h,window.updateScoreTable=g}));
