document.addEventListener("DOMContentLoaded",(function(){const e=()=>{const e=document.cookie.split(";");for(let t of e){const[e,a]=t.trim().split("=");if("sessionID"===e)return decodeURIComponent(a)}return null},t=io("",{query:{role:"facilitator",type:"dashboard",id:e()}}),a=[],o=[];let n=null,s=null,r=null,i=0;const l={prop:null,dir:!0,timeout:-1},c="facilitator-slideshow-controls",d="facilitate",m={RESET_WARN:"Are you sure? This will reset all game progress, and any connected players will need to rejoin.",RESET_DONE:"The game has been reset. Any connected players will need to refresh their browser to rejoin.",END_WARN:"Ending the game cannot be undone, please enter your password to continue.",SESSION_WARN:"Continuing will reset the session, remove all players and mark this game as 'pending'. Are you sure you want to do this?",SESSION_DONE:"The session has been reset.",NORESET:"Cannot reset teams once scores have been submitted",noStart:{started:"The game has already started.",ended:"Cannot start game, this session has already concluded."}},u=4;t.on("checkOnConnection",(()=>{s=null,p("connected to app"),Ie()}));const p=(e,t)=>{const n={id:a.length,msg:e,important:void 0!==t};a.push(`${a.length+1}: ${e}`),o.push(`${a.length+1}: ${e}`),f(),t&&(e=>{const t=$("#facilitateMessage");t&&(t.html(`<p>${e.msg}</p>`),setTimeout((()=>{}),5e3))})(n)},f=()=>{const e=$("#logFeed");e.is(":visible")||setTimeout((()=>{e.show()}),200),window.renderTemplate("logFeed","facilitatorLogFeed",a)},w=e=>{t.emit("resetSession",n.uniqueID,(t=>{if("string"==typeof t);else{const a=t.game;k(a),n=t.session,localStorage.clear(),ye(d),e&&e()}localStorage.clear(),window.location.reload()}))},h=()=>{p("start new game"),"pending"===n.state?(t.emit("preparePresentation",{sessionID:n.uniqueID,type:n.type,address:n.address}),t.emit("startGame",JSON.stringify(n),(e=>{console.log("startGame callback, rgame:",e),k(e),p("game ready"),ge(s.uniqueID,(()=>{})),ne(),ye("facilitate")}))):alert(m.noStart[n.state])},g=()=>{null===s&&(t.emit("restoreGame",JSON.stringify(n),(e=>{null===s&&(clearTimeout(r),p("game restore complete - game can recommence"),k(e),ne())})),clearTimeout(r),r=setTimeout(g,200))},y=e=>{let a=window.prompt(m.END_WARN);a&&t.emit("testPassword",{session:n.uniqueID,pw:a},(a=>{a?(console.log("OK to end"),t.emit("endGame",s,(t=>{k(t),ne(),ye(d),e&&e()}))):alert("Incorrect password")}))},b=e=>{if(window.confirm(m.RESET_WARN)){const a=s.uniqueID;p(`resetting game ${a}`),t.emit("resetGame",a,(t=>{n=t,ye(d),oe(),ne(!0),e&&e(),(()=>{let e=localStorage;const t=["votes","collabs","renderState","roundState"];Object.keys(e).forEach((e=>{t.some((t=>e.includes(t)))&&localStorage.removeItem(e)})),e=localStorage})(),window.location.reload()}))}},k=e=>{if(s)if(e.hasOwnProperty("updateType"))switch(e.updateType){case"add":s.hasOwnProperty(e.dest)&&(s[e.dest][e.new.id]=e.new);break;case"replace":s[e.dest]=e.new;break;default:console.warn(`updateType '${e.updateType}' has no associated action; game will not be updated`)}else Object.assign(s,e);else s=Object.assign({},e),window.gameShare(s)},S=t=>{t._updateSource;const a=procVal;const o=ke(t,"playersFull"),n=Se(t.scores);if(n.length>0&&(e=>{e.length>1&&console.warn("multiple score changes detected - should not be possible, check code");const t=e.map(unpackScore)[0];window.findRoundTrigger(t.round),window.renderScoreboard("insertion")})(n),t.round.toString().includes("*")&&p(`round ${s.round} complete`),t.hasOwnProperty("_updateSource")&&t._updateSource.hasOwnProperty("event")){let e="white";switch(t._updateSource.event.split(" ")[1].toLowerCase()){case"scoresubmitted":case"scoreforaveragesubmitted":e="red";break;case"endround":e="green";break;default:e="white"}}if(o){const n=o.filter((e=>!e.includes("warning"))),s=Boolean(-1===n.slice(0).indexOf("socketID",0));if(a(t.uniqueID)===a(e())){let e=!0;if(p("gameUpdate"),t._updateSource){if(t._updateSource.type&&"player"===t._updateSource.type){e=!1;const a=window.clone(t);console.log("we will only update the player now, player:");const o=a.playersFull[a._updateSource.playerID];console.log(o),k(o?{updateType:"add",dest:"playersFull",id:o.id,new:o}:{updateType:"replace",dest:"playersFull",new:a.playersFull}),k({updateType:"replace",dest:"players",new:a.players}),k({updateType:"replace",dest:"teams",new:a.teams})}}else console.warn("no _updateSource provided, SLEDGEHAMMER METHOD - will update entire game");e&&(console.warn("full game update"),k(t)),s&&L(F().title),clearTimeout(i),i=setTimeout((()=>{ae("facilitatePlayersContent"),Q(),X(),we()}),300),$("#roundcompleter").length>0&&$("#roundcompleter").is(":visible")&&(De(),Y())}}else console.warn("gameUpdate has not completed due to a failure at compareGames method")},v=()=>{window.open(`/presentation#${s.address.replace("/","")}`,"_blank")},T=()=>{window.open(`/fakegenerator#${s.address}`,"_blank")},O=()=>{const e=$("#contentTeams").find(".link");e.off("click"),e.on("click",(function(){t.emit("identifyPlayer",{game:s,player:$(this).attr("id").split("_")[2]})}))},I=(e,t)=>e.connected&&!t.connected?l.dir?-1:1:!e.connected&&t.connected?l.dir?1:-1:0,D=(e,t)=>e.isLead&&!t.isLead?l.dir?-1:1:!e.islead&&t.isLead?l.dir?1:-1:0,C=(e,t)=>{const a=parseInt(e.index),o=parseInt(t.index);return void 0===a||void 0===o?0:a<o?l.dir?-1:1:a>o?l.dir?1:-1:0},E=(e,t)=>{const a=parseInt(e.id.replace(/pf/g,"")),o=parseInt(t.id.replace(/pf/g,""));return void 0===a||void 0===o?0:a<o?l.dir?-1:1:a>o?l.dir?1:-1:0},P=(e,t)=>{const a=e.teamObj,o=t.teamObj;if(void 0===a||void 0===o)return 0;const n=a.title,s=o.title;return void 0===n||void 0===s?0:n<s?l.dir?-1:1:n>s?l.dir?1:-1:0},N=e=>{e.remove()},R=e=>{const t=e.closest(".widget").attr("id");N($(`#${t}`))},j=(e,t)=>{let a={},o=localStorage.getItem(e);o&&(a=JSON.parse(o)),a=Object.assign(a,t),localStorage.setItem(e,JSON.stringify(a))},x=(e,t,a)=>{const o=`#${e}`,n=$(o),r=`wid-${s.uniqueID}${o}`,i={x:t.x?t.x:0,y:t.y?t.y:0,w:t.w?t.w:0,h:t.h?t.h:0};if(0===n.length){$("#overlay").append(`<div class="widget" id="${e}"></div>`);let n=localStorage.getItem(r);n&&Object.assign(i,JSON.parse(n));let s={id:e,partialName:e};t.hasOwnProperty("data")&&(s=Object.assign(s,t.data));const l=t.data.preventTemplate?"facilitator.widget.nopartial":"facilitator.widget";i.x=i.w+i.x>window.innerWidth?window.innerWidth-i.w-40:i.x,i.y=i.h+i.y>window.innerHeight?window.innerHeight-i.h-40:i.y;const c={open:!0};t.hasOwnProperty("data")&&t.data.hasOwnProperty("launchMethod")&&(c.launchMethod=t.data.launchMethod),j(r,c),renderTemplate(e,l,s,(()=>{$(o).css({left:`${i.x}px`,top:`${i.y}px`,width:`${i.w}px`,height:`${i.h}px`});i.x,i.y;const e=$(o).find("#widgetouter"),t=$(o).find("#widgethandle"),n=$(o).find("#widgethandle").find(".widgetclose");e.css({width:"100%",height:"100%"}),n.off("click").on("click",(function(){j(r,{open:!1}),N($(o))})),$(o).draggable({handle:t,containment:"window",stop:function(){const e={x:$(this).position().left,y:$(this).position().top};j(r,e)}}),a&&a($(o))}))}},A=e=>{const a={address:s.address,type:"order",preview:!1};let o=!1;return e&&(a.force=!0),0===s.teams.length?t.emit("assignTeams",a,(e=>{"string"==typeof e?p(e,!0):(p("teams successfully assigned",!0),S(e),_("teams"),o=!0)})):p("teams already assigned",!0),o},L=e=>{const t=["players","scores","game","session"].indexOf(e,0)>-1;if(0===$(`#content${window.toCamelCase(e)}`).children().length||t)switch(e){case"session":oe(),G();break;case"game":ne(),W();break;case"controls":de();break;case"facilitate":fe();break;case"players":ae("contentPlayers");break;case"teams":ce();break;case"scores":le(),ie();break;default:console.log("setupTab: invalid argument provided.")}},q=()=>{const e="started"===n.state,t=$("#linkGame"),a=$("#linkControls"),o=($("#linkFacilitate"),$("#linkScores"));t.prop("disabled",!e),a.prop("disabled",!e),o.prop("disabled",!e)},_=e=>{const t=`#link${toCamelCase(e)}`,a=$(t),o=a.css("color"),n="red";a.css({color:n,"background-color":"yellow"}).delay(100).animate({color:o,"background-color":"transparent"},500).animate({color:n,"background-color":"yellow"},10).delay(100).animate({color:o,"background-color":"transparent"},500).animate({color:n,"background-color":"yellow"},10).delay(100).animate({color:o,"background-color":"transparent"},500)},F=()=>{const e=$(".tabcontent:visible"),t={title:"noTab"};return e.length>0&&(t.el=e,t.title=e.attr("id").replace("tab","").toLowerCase()),t},M=()=>{setTimeout((()=>{let e=$("#clearLog"),t=$(".tablinks");e.off("click"),t.off("click"),e.on("click",(()=>{a.splice(0,a.length),f()})),t.on("click",(function(){$("#overlay").find(".widget").each(((e,t)=>{$(t).remove()})),ye($(this).attr("id").replace("link",""))}));const o=d;q(),ye(o)}),500)},G=()=>{p("setupSessionLinks");let e=$("#gameStart"),t=$("#sessionReset"),a=$("#gameLaunch");$(".link").off("click"),e.on("click",h),t.on("click",w),"started"!==n.state&&(a.addClass("disabled"),document.getElementById("gameLaunch")&&document.getElementById("gameLaunch").addEventListener("click",(e=>{e.preventDefault()})))},W=()=>{if(s&&"started"===s.state){["#gameReset","#makeFakes","#gameEnd","#makePres"].forEach((e=>{$(e).off("click").on("click",(()=>{switch(e){case"#gameReset":b();break;case"#makeFakes":T();break;case"#makePres":v();break;case"#gameEnd":y()}}))}))}},J=()=>{const e=$("#contentControls").find(".buttonSet").find("button");$("#roundInput");["#preview","#resize","#assign","#reset","#identify","#startRound","#completeRound","#checkRound","#slideshow","#setName","#clearConsole","#presInfo","#downloadRes","#signOut"].forEach((e=>{$(e).off("click").on("click",(()=>{const a=parseInt($("#roundInput").val());switch(e){case"#setName":const e=$("#nameInput").val();e?t.emit("sessionNameChange",{gameID:s.uniqueID,name:e}):alert("no name provided");break;case"#preview":(async()=>{const e={address:s.address,type:"order",preview:!0},a=!1;t.emit("assignTeams",e,(e=>{if("string"==typeof e);else{const t=e.persistentData.teams,o=e.teams;let n="Team breakdown Preview:\n";o.forEach(((e,a)=>{n+=`${t["t"+a].title}:  ${e.join(", ")} (${e.length} player${1===e.length?"":"s"})\n`})),a=!0}return a}))})();break;case"#resize":(()=>{const e=`game-${s.uniqueID}`,a=parseInt($("#teamInput").val());t.emit("setTeamSize",{gameID:e,n:a},(e=>{S(e)}))})();break;case"#assign":A();break;case"#reset":0===s.scores.length?t.emit("resetTeams",{address:s.address},(e=>{p("teams reset"),S(e)})):alert(m.NORESET);break;case"#identify":t.emit("identifyPlayers",s);break;case"#slideshow":H();break;case"#startRound":z(a);break;case"#completeRound":Y(a);break;case"#checkRound":const o=parseInt($("#roundInput").val());t.emit("checkRound",{gameID:s.uniqueID,round:o},(e=>{K(e,s.persistentData[s.persistentData.rounds[o].teams])}));break;case"#clearConsole":console.clear();break;case"#presInfo":t.emit("togglePresInfo",s.address);break;case"#downloadRes":ve();break;case"#signOut":confirm("Are you sure you want to sign out of this session?")&&(document.cookie.split(";").forEach((e=>{const t=e.indexOf("="),a=t>-1?e.substring(0,t):e;document.cookie=a+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"})),window.location.replace("facilitatorlogin"))}}))})),e.off("click").on("click",(function(){const e=$(this).parent().parent().find(".valInput"),t=parseInt(e.val());e.val("+"===$(this).html()?t+1:t-1),e.val(parseInt(e.val())<-1?-1:e.val())})),U()},U=()=>{const e=$("#facilitator-advanced"),a=e.find("#reset"),o=e.find("#launchqr"),n=e.find("#showqr"),r=e.find("#gameEnding"),i=e.find("#gameReset"),l=e.find("#sessionReset"),c=e.find("#fakeGen"),d=e.find("#refreshAll"),u=e.find("#removeAll"),p=e.find("#allHome");a.add("#completeRound"),a.each(((e,t)=>{$(t).attr("id")&&$(t).on("click",(function(){R($(this))}))})),o.off("click").on("click",(()=>{re()})),n.off("click").on("click",(()=>{t.emit("presentationOverlay",{type:"qr",game:s.address})})),r.off("click").on("click",(()=>{y((()=>{R(r)}))})),l.off("click").on("click",(()=>{confirm(m.SESSION_WARN)&&w((()=>{R(l),alert(m.SESSION_DONE)}))})),i.off("click").on("click",(()=>{b((()=>{R(i)}))})),c.off("click").on("click",(()=>{T()})),d.off("click").on("click",(()=>{confirm(`Are you sure you want to refresh all ${s.players.length} players browsers?`)&&Z()})),u.off("click").on("click",(()=>{confirm(`Are you sure you want to close all ${s.players.length} players browsers?`)&&ee()})),p.off("click").on("click",(()=>{confirm(`This will send all ${s.players.length} players back to the home page, are you sure you want to do this?`)&&te()}))},V=async(e,a)=>{t.emit("requestCSV",e,(e=>{try{const t=new Blob([e],{type:"text/csv"}),o=document.createElement("a");o.href=window.URL.createObjectURL(t),o.download=`${a}.csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o)}catch(e){console.error("Error:",e)}}))},B=e=>{const a=l,o=$(`#${e||"contentPlayers"}`),n=o.find(".listSort"),r=o.find(".makeLead"),i=o.find(".reassign"),c=o.find(".refresh"),d=o.find(".remove"),m=(o.find(".rollover"),o.find(".warning"));n.off("click").on("click",(function(){a.dir=a.prop!==this.textContent||!a.dir,a.prop=this.textContent,ae(e);const t=n.filter((function(){return $(this).text().trim()===a.prop})).index();$(n[t]).addClass("highlight")})),r.off("click").on("click",(function(){const e=$(this).attr("id").split("_").splice(1),a={game:s.uniqueID,team:parseInt(e[0]),player:e[1]};t.emit("makeLead",a)})),i.off("click").on("click",(function(){const e=$(this).attr("id").split("_").splice(1),a=parseInt(e[0]),o={game:s.uniqueID,team:a,player:e[1]},n=s.persistentData.teamsArray;if(0===s.teams[a].indexOf(e[1])&&2!==n[a].type)return void alert("Cannot reassign a team lead");let r="",i=[];n.forEach((e=>{e.id!=a&&(i.push(e.id),r+=`\n${e.id} ${e.title}`)}));let l=prompt(`Type the NUMBER of the team you would like to reassign ${e[1]} to:${r}`);if(l)if(isNaN(parseInt(l)))alert("You need to enter the number for the team you would like to rassign to, please try again.");else if(l=parseInt(l),i.indexOf(l)>-1){const a=confirm(`You are about to move ${e[1]} to the ${n[l].title} team, is this OK?`);o.newTeam=l,a&&t.emit("reassignTeam",o)}else alert(`Not possible, the allowed set of options is ${i}.`)})),c.off("click").on("click",(function(){const e=$(this).attr("id").split("_").splice(2),a=s.playersFull[`${e}`],o=a?a.socketID:"",n={game:s.uniqueID,player:a,socketID:o};t.emit("refreshClient",n)})),d.off("click").on("click",(function(){let e;const a=$(this).attr("id").split("_")[2],o={game:s.uniqueID,player:a};if(console.log(o),s.playersFull.hasOwnProperty(`${a}`)){const t=s.playersFull[`${a}`];if(t.isLead&&(e=confirm("It is risky to remove a team lead, consider assigning a new lead first. Click OK if you are sure you want to remove the player."),!e))return;t.connected&&alert("Note: removing a currently connected player may cause unexpected results"),t.teamObj&&alert("Note: removing a player already assigned to a team may cause unexpected results")}e=confirm(`Are you absolutely sure you want to remove player ${a}`),e&&t.emit("removePlayer",o,(e=>{e.hasOwnProperty("err")&&alert(`Cannot remove ${a}: ${e.err}`)}))})),m.off("click").on("click",(function(){const e=$(this).closest("tr").index()-1;alert(list[e].warningMessage)}));o.find(".material-icons");o.find(".material-icons:disabled").removeAttr("title")},H=()=>{x(c,{x:400,y:200,w:600,h:600},(()=>{window.slideContolsInit(s)}))},z=(e,a)=>{const o=s.teams,n=s.players,r=void 0===a||a;e=window.justNumber(e);const i=window.justNumber(s.round),l=s.round.toString().indexOf("*",0)>-1||0===i,c=e-i===1;let d=t.emit("checkDevMode",(e=>{})),m=`Cannot start round ${e}:\n`;return 0===n.length&&e>0?(m+="no players connected, cannot start round",d=!1):0===o.length&&e>0?(m+="teams not yet assigned, must wait for allocation",d=!1):l&&i>0&&i===e?(m+="round is already completed",d=!1):e===i?(m+="round already in progress",d=!1):l?c?d=!0:m+="gap between rounds is not exactly 1, cannot continue":(m+="current round incomplete, must wait for completion",d=!1),p(d?`round ${e} started successfully`:m,!0),r&&(te(),t.emit("startRound",{gameID:s.uniqueID,round:e,ok:d})),d},K=(e,t)=>{let a="Team submitted score:\n\n";t.forEach(((t,o)=>{a+=`${t.title}? ${e[o]}\n`})),alert(a)},Y=()=>{t.emit("getGame",s.address,(e=>{k(e);const t=window.justNumber(s.round),a=s.playersFull;if($.isEmptyObject(a))alert("Can't complete this action, game.playersFull is not defined. Try reconnecting any fake player clients.");else if(t>0){const e=s.persistentData.rounds[t],a=(e.submissions,s.persistentData[e.teams]),o=filterScorePackets(s.scores.map(unpackScore),"round",e.n);let n=[];const r={teams:[],players:[],scorers:[]};1===e.type?n=a:a.forEach((e=>{s.teams[e.id].forEach((e=>{n.push(s.playersFull[e])}))})),n.forEach((t=>{const a=1===e.type?{prop:"src",val:t.id}:{prop:"client",val:justNumber(t.id)};0===filterScorePackets(o,a.prop,a.val).length&&r.scorers.push(Object.assign({flag:1===e.type?t.title:`${t.teamObj.title} ${t.id}`},t))})),$("#modal").modal({closeExisting:!0}),r.isLead=!0,r.currentRoundComplete=!1,r.scorers.length>0?renderTemplate("modaltheatre","facilitator.roundcompleter",r,(()=>{let t=$(".modtablinks");t.off("click"),t.on("click",(function(){const t={isLead:!0,currentRoundComplete:!1},a=$(this).attr("id").replace("link_","");1===e.type?t.teamObj=s.persistentData.teams[`t${a}`]:s.teams.forEach(((e,o)=>{e.indexOf(a,0)>-1&&(t.teamObj=s.persistentData.teams[`t${o}`])}));const o=s.playersFull[1===e.type?s.teams[t.teamObj.id][0]:a];t.game=s,o.teamObj=Object.assign({},t.teamObj),$("#formname").html(t.teamObj.title),t.dynamicTeamData=window.createDynamicTeamData(),renderPartial("formzone",`game-${e.template}`,t,(()=>{$(".resources-btn").css({width:"30px",height:"30px","background-color":"green"}),1===e.type?e.n===u?window.setupCollaborationControl(o):window.setupAllocationControl(o):window.setupVoteControl(o)}))}))})):$("#modaltheatre").html(`Round ${t} is complete, no further input needed.`)}else alert("No round currently active.")}))},Q=()=>{const e=s.playersFull,t=new Array(s.mainTeamSize*s.persistentData.mainTeams.length+s.persistentData.secondaryTeams.length).fill("no");let a=0;Object.values(e).forEach((e=>{e.connected&&(a<t.length&&(t[a]="yes"),a++)})),renderTemplate("playermeter","facilitator.playermeter",{total:t,required:t.length,connected:a},(()=>{}))},X=()=>{const e=s.persistentData.rounds,t=s.presentation.slideData.slideList,a=[];t.forEach((t=>{if(t.hasOwnProperty("action")&&t.action.includes("startRound")){const o=t.action.split(":")[1],n={round:o,titleFull:t.title,title:t.title.replace(/\([^)]*\)/g,""),data:e[o],current:justNumber(s.round)===justNumber(o),complete:s.round.toString().includes("*")&&justNumber(s.round)===justNumber(o)||justNumber(s.round)>justNumber(o)};a.push(n)}})),renderTemplate("facilitateRoundsContent","facilitator.rounds",a,(()=>{}))},Z=()=>{t.emit("refreshAllClients",s.address)},ee=()=>{t.emit("getGame",s.address,(e=>{e.players.forEach((e=>{const a={game:s.uniqueID,player:e,alsoClose:!0};console.log(a),t.emit("removePlayer",a,(e=>{e.hasOwnProperty("err")&&console.warn(`Could not remove: ${e.err}`)}))}))}))},te=()=>{t.emit("sendClientsHome",s.address)},ae=e=>{if(s){let t=s.players.slice(0);const a=Object.assign({},s.playersFull);t.forEach(((e,a)=>t[a]={id:e,connected:!1}));let o=t;o.forEach(((e,t)=>{a.hasOwnProperty(e.id)?o[t]=a[e.id]:e.id.hasOwnProperty("id")&&(a.hasOwnProperty(e.id.id)?o[t]=a[e.id.id]:o[t]=e.id);if(o[t].teamObj){const e=o[t].teamObj.title;o[t].teamObj.titleClip=`${e.substr(0,8)}${e.length>8?".."+e.substr(e.length-1,1):""}`}}));const n=l;switch(n.prop){case"index":o.sort(C);break;case"ID":o.sort(E);break;case"connected":o.sort(I);break;case"team":o.sort(P);break;case"isLead":o.sort(D)}o=(e=>(e.forEach(((t,a)=>{!t.connected&&t.isLead&&(e[a].warning=!0,e[a].warningMessage="Team lead is disconnected, consider assigning new lead if they do not reconnect shortly.")})),e))(o),clearTimeout(n.timeout),renderTemplate(e,"playerlist",o,(()=>{B(e)}))}},oe=()=>{const e="contentSession";window.setupObserver(e,(()=>{G()})),window.renderTemplate(e,"sessionCardFacilitator",n,(()=>{G()}))},ne=e=>{const t="contentGame";window.setupObserver(t,(()=>{W()}));let a={game:window.copyObjectWithExclusions(s,["persistentData","playersFull","scorePackets","detailedScorePackets","teamObjects","presentation","updateSource","teams","players","scores","values"])};a.gameInactive="started"!==a.game.state,e?$(`#${t}`).html(""):window.renderTemplate(t,"gameCard",a,(()=>{}))};const se=()=>{x("facilitator-scoreboard",{x:100,y:100,w:1100,h:290,data:{preventTemplate:!0,launchMethod:"launchScoreboard"}},(e=>{(()=>{const e="facilitator-scoreboard";renderTemplate(`widgetinner${e}`,"facilitator.scoreboard",{game:s},(()=>{const t=$(`#widgetinner${e}`);$(`#widgetinner${e}`).parent(),t.find("div"),window.initScoreboard(s.address,"dashboard",s),window.renderScoreboard("insertion")}))})()}))},re=()=>{x("facilitator-qrs",{x:100,y:100,w:420,h:270,data:{preventTemplate:!0,launchMethod:"launchQRs"}},(e=>{(()=>{const e="facilitator-qrs";renderTemplate(`widgetinner${e}`,"facilitator.qrs",{game:s},(()=>{const t=$(`#widgetinner${e}`);$(`#widgetinner${e}`).parent(),t.find("div"),t.find(".qrcode").css({width:"200px",float:"left"})}))})()}))},ie=async()=>{},le=async()=>{},ce=()=>{let e={};if(s){const t=s.persistentData.teams,a=s.teams;Object.values(t).forEach(((t,o)=>{t.hasOwnProperty("id")&&a[o]&&(e[t.id]={name:t.title,team:a[o].toString(),players:a[o]})})),window.renderTemplate("contentTeams","teamsCard",e,(()=>{O()}))}},de=()=>{if(s){const e=s.teams.length>0,t={disableAssignTeams:e,disableDownload:"4*"!==s.round,game:s};window.renderTemplate("contentControls","facilitator.controls",t,(()=>{J(),e&&ce(),localStorage.getItem(c)&&H()}))}else console.log("no game")},me=()=>{const e=Object.assign({hasName:void 0!==n.name,playersConnected:n.players.length>0,playerCount:n.players.length},n);renderTemplate("contentFacilitate","facilitator.start",e,(()=>{window.loadCSS("facilitator.intro"),window.facIntroInit(e)}))},ue=async()=>{await(async e=>{if(s){s.scores;const a=s.persistentData.mainTeams,o=[];let n=await emitWithPromise(t,"getTotals1",s.uniqueID);n&&(n=JSON.parse(n),n=roundAll(n)),t.emit("getScorePackets",s.uniqueID,(t=>{a.forEach((e=>{const a=t.filter((t=>t.dest===e.id)),n={team:`${e.title.substr(0,10)}${e.title.length>10?"..":""}`,id:e.id,r1:a.filter((e=>1===e.round)),r2s5:a.filter((e=>2===e.round)).filter((e=>5===e.src)),r2s6:a.filter((e=>2===e.round)).filter((e=>6===e.src)),r2s5Summary:{total:0,average:0,scores:[]},r2s6Summary:{total:0,average:0,scores:[]}};n.r1Summary={total:0===n.r1.length?0:n.r1[0].val},n.r2s5.forEach((e=>{n.r2s5Summary.total+=e.val,n.r2s5Summary.scores.push(e.val)})),n.r2s6.forEach((e=>{n.r2s6Summary.total+=e.val,n.r2s6Summary.scores.push(e.val)})),n.r2s5Summary.average=0===n.r2s5.length?0:n.r2s5Summary.total/n.r2s5.length,n.r2s6Summary.average=0===n.r2s6.length?0:n.r2s6Summary.total/n.r2s6.length,n.r1Total=n.r1Summary.total,n.r2s5All=0===n.r2s5Summary.scores.length?"n/a":n.r2s5Summary.scores.join(","),n.r2s5Av=n.r2s5Summary.average,n.r2s6All=0===n.r2s6Summary.scores.length?"n/a":n.r2s6Summary.scores.join(","),n.r2s6Av=n.r2s6Summary.average,n.r2Total=n.r2s5Summary.average+n.r2s6Summary.average,n.grandTotal=n.r2Total*n.r1Total,o.push(n)})),sortBy(o,"grandTotal",!0),e&&e(o)}))}else e&&e("nuffink")})((e=>{console.log("scores?"),console.log(e)}));console.log("renderOutro"),console.log(s),console.log(n),renderTemplate("contentFacilitate","facilitator.end",n,(()=>{$("#adminGameReset").off("click").on("click",(()=>{let e=window.prompt("Enter admin password");e&&t.emit("testPassword",{adminOnly:!0,session:n.uniqueID,pw:e},(a=>{t.emit("resetEndedGame",{pw:e,session:n.uniqueID},(e=>{if("object"==typeof e){n=Object.assign(n,e);const t=window.mapSessionToGame(e,s);k(t),fe()}else alert(a?"OK to reset, but a session object has not been returned.":"Cannot reset, password incorrect.")}))}))}))}))},pe=e=>{let t=e.presentation.slideData.slideList.slice(0);t.forEach(((e,a)=>{e._titleSimple=e.title,e.title=e.title.replace(/\(/gm,'<span class="hint">(').replace(/\)/gm,")</span>"),t[a]=window.reorderObject(e,"_titleSimple")}));const a=t.filter((e=>!e.exclude));renderTemplate("slidelist","facilitator.slidelist",a,(()=>{$("#tabFacilitate").css({height:"700px"}),window.slideContolsInit(e),window.updateSlideList()}))},fe=()=>{if(s)"ended"===s.state?ue():"pending"===s.state?me():(s.urlPresentation=`${s.base}/presentation#${s.address.replace("/","")}`,renderTemplate("contentFacilitate","facilitator.facilitate",s,(()=>{pe(s),ae("facilitatePlayersContent");$("#facilitateSlideshow").find("#makePres").off("click").on("click",(()=>{v()})),Q(),X();$("#openAdvanced").off("click").on("click",(()=>{x("facilitator-advanced",{x:100,y:100,w:500,h:230,data:{preventTemplate:!0,launchMethod:"launchAdvanced"}},(e=>{we()}))})),window.createCopyLinks(),(async()=>{renderTemplate("facilitateScoresContent","scoreslaunch",{},(()=>{$("#facilitateScoresContent").find("button").off("click").on("click",(()=>{se()}))}))})()})));else switch(n.state){case"pending":me();break;case"ended":ue()}},we=async()=>{const e="facilitator-advanced",t={game:s},a=await window.checkDevMode();t.teamsAssigned=s.teams.length>0,t.roundActive=s.round>0,t.scoresSubmitted=s.scores.length>0,t.preventTemplate=!0,t.disableDownload="4*"!==s.round,t.isDev=a,renderTemplate(`widgetinner${e}`,"facilitator.advanced",t,(()=>{const t=$(`#widgetinner${e}`),a=$(`#widgetinner${e}`).parent(),o=t.find("div");a.css({height:`${o.height()+50}px`}),J()}))},he=async()=>{p(`initSession, session state? ${n.state}`),M(),(()=>{const e=Object.keys({...localStorage}).filter((e=>e.includes("wid")));e&&e.forEach((e=>{const t=JSON.parse(localStorage.getItem(e));t.hasOwnProperty("launchMethod")&&setTimeout((()=>{"launchScoreboard"===t.launchMethod&&t.open&&se()}),1e3)}))})(),"started"===n.state&&(p("session already started, restore"),g())},ge=e=>{fetch("/admin/getSession?sessionID="+e,{method:"POST",headers:{"Content-Type":"application/json"}}).then((e=>{if(!e.ok){const e="Failed to get session data";throw p(e),new Error(e)}return e.json()})).then((e=>{n=e,n.base=window.location.origin,n.localIP&&(n.localIP=window.procVal(n.localIP),n.localIP&&(n.base=n.base.replace("localhost",n.localIP))),n.playerURL=`${n.base}${n.address}`,p("session data found:"),p(`${JSON.stringify(e).substr(0,45)}...`),he()})).catch((e=>{console.error("Error:",e)}))},ye=e=>{const t=F();e!==t.title&&t.hasOwnProperty("el")&&$(`#content${window.toCamelCase(t.title)}`).html(""),$(`#content${window.toCamelCase(t.title)}`).html("");const a=`${e.substr(0,1).toUpperCase()}${e.substr(1).toLowerCase()}`,o=$(".tabcontent"),n=$(".tablinks"),s=$(`#tab${a}`),r=$(`#link${a}`);o.hide(),n.removeClass("active"),s.show(),r.addClass("active"),L(e.toLowerCase()),q()},be=(e,t)=>JSON.stringify(e)===JSON.stringify(t);let $e=[];window.showChangeReport=()=>{$e.filter((e=>!e.prop.includes("warning"))).forEach((e=>{console.log(`${e.player} ${e.prop} from ${e.old} to ${e.new}`)}))};const ke=(e,t)=>{if(s){e.hasOwnProperty("updateSource")&&e.updateSource;let a=[];return be(e[t],s[t])||(a=[],Object.entries(e[t]).forEach(((e,o)=>{if(!be(e[1],s[t][e[0]])){const o=s[t][e[0]],n=e[1];for(let t in o)if(!be(o[t],n[t])){const s={player:e[0],prop:t,old:o[t],new:n[t]};$e.push(s),a.push(t)}}}))),a}},Se=e=>{const t=s?s.scores:[],a=e,o=[...t],n=[...a];return o.filter((e=>!a.includes(e))).concat(n.filter((e=>!t.includes(e))))},ve=async()=>{const e=s.persistentData.mainTeams,a=await emitWithPromise(t,"getTotals4",s.uniqueID),o=[];a&&(a.forEach(((t,a)=>{const n={team:t.team,"Player Resources":t.self};n["Public Voice Resources 1"]=roundNumber(t.pvR2Total,3),e.forEach((e=>{n[e.abbr]=e.id===a?"x":t.summary_r3[e.id]})),n["Total Player Resources"]=t.total,n["Public Voice Resources 2"]=roundNumber(t.pvR4Total,3),n["Total Score"]=t.gtRound,o.push(n)})),o.forEach((e=>console.log(e))),V(o,`sus_${s.address.replace("/","")}_results`))},Te={rAssignTeams:A},Oe=async e=>{if(!s)return;const a=s.presentation.slideData.slideList[e];let o=!0,n=!1,r=null;try{if(!a)throw new Error("no slide");if(!a.hasOwnProperty("action"))throw new Error("no action");if(r=a.action,r.includes("startRound")){const e=parseInt(r.split(":")[1]);n=!0,o=z(e)}if(r.toLowerCase().includes("assignteams")){n=!0;o="object"==typeof await emitWithPromise(t,"assignTeams",{address:s.address,type:"order",preview:!0})&&0===s.teams.length}}catch(e){}return{tested:n,test:o,ac:r}};const Ie=()=>{const a=e();window.socketShare(t,"fdb_socket"),p(`sessionID: ${a}`),a&&ge(a)};t.on("test",(()=>{console.log("test")})),t.on("gameUpdate",(e=>{S(e)})),t.on("onGameRestored",(e=>{})),t.on("playerUpdate",(e=>{})),t.on("teamsAssigned",(e=>{s.teams=e.teams,s.playersFull=e.playersFull,ae("facilitatePlayersContent"),pe(e)})),t.on("scoreSubmitted",(e=>{})),t.on("presentationSlideUpdated",(e=>{})),t.on("onShowSlide",(e=>{(async e=>{const t=e.ref;await Oe(t)})(e)})),t.on("gameWarning",(e=>{alert(e.warning)})),t.on("gotoNext",(()=>{console.log("facilitatorDashboard hears gotoNext"),window.pEvent("next")})),t.on("roundComplete",(e=>{p(`yes, round ${e.round} complete`,!0),e.round>0&&e.persistentData.rounds[e.round].hasOwnProperty("completionMsg")})),renderTemplate=window.renderTemplate,renderPartial=window.renderPartial,procVal=window.procVal,window.showGame=()=>s,window.showTeams=()=>{let e="no teams to show";return s.teams&&(e=s.teams),e},window.startGame=h,window.getSessionID=e,window.showScores=async()=>{let e=await emitWithPromise(t,"getTotals1",s.uniqueID);return e?(console.log(JSON.parse(e)),e):"nothing to show"},window.facilitatorSlideChange=e=>{(()=>{const e=$("#facilitateMessage");e&&e.html("")})();const t=s.presentation.slideData.slideList[e.currentSlide];t.action&&(t.action.includes("startRound"),t.action.includes("showRound"),Te.hasOwnProperty(t.action)&&Te[t.action]())},window.renderFacilitate=fe,window.slideTest=Oe;const De=()=>{$("#modal").modal("close")};window.closeModal=De,window.devCompleteR1=()=>{s.persistentData.mainTeams.forEach(((e,a)=>{console.log(a,Math.round(5*Math.random()));const o={scoreCode:{src:a,dest:a,val:Math.round(5*Math.random())},game:s.uniqueID,client:a};t.emit("submitScore",o,(e=>{window.setupAllocationControl()}))}))},null===e()&&window.location.replace("facilitatorlogin")}));
