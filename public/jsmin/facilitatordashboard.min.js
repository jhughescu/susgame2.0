document.addEventListener("DOMContentLoaded",(function(){const e=()=>{const e=document.cookie.split(";");for(let t of e){const[e,a]=t.trim().split("=");if("sessionID"===e)return decodeURIComponent(a)}return null},t=io("",{query:{role:"facilitator",type:"dashboard",id:e()}}),a=[],n=[];let o=null,s=null,r=null,i=0;const l={prop:null,dir:!0,timeout:-1},c="facilitator-slideshow-controls",d="facilitate",m={RESET_WARN:"Are you sure? This will reset all game progress, and any connected players will need to rejoin.",RESET_DONE:"The game has been reset. Any connected players will need to refresh their browser to rejoin.",END_WARN:"Ending the game cannot be undone, please enter your password to continue.",SESSION_WARN:"Continuing will reset the session, remove all players and mark this game as 'pending'. Are you sure you want to do this?",SESSION_DONE:"The session has been reset.",NORESET:"Cannot reset teams once scores have been submitted",noStart:{started:"The game has already started.",ended:"Cannot start game, this session has already concluded."}},u=4;t.on("checkOnConnection",(()=>{s=null,p("connected to app"),Ie()}));const p=(e,t)=>{const o={id:a.length,msg:e,important:void 0!==t};a.push(`${a.length+1}: ${e}`),n.push(`${a.length+1}: ${e}`),f(),t&&(e=>{const t=$("#facilitateMessage");t&&(t.html(`<p>${e.msg}</p>`),setTimeout((()=>{}),5e3))})(o)},f=()=>{const e=$("#logFeed");e.is(":visible")||setTimeout((()=>{e.show()}),200),window.renderTemplate("logFeed","facilitatorLogFeed",a)},w=e=>{t.emit("resetSession",o.uniqueID,(t=>{if("string"==typeof t);else{const a=t.game;k(a),o=t.session,localStorage.clear(),be(d),e&&e()}localStorage.clear(),window.location.reload()}))},h=()=>{p("start new game"),"pending"===o.state?(t.emit("preparePresentation",{sessionID:o.uniqueID,type:o.type,address:o.address}),t.emit("startGame",JSON.stringify(o),(e=>{console.log("startGame callback, rgame:",e),k(e),p("game ready"),ye(s.uniqueID,(()=>{})),se(),be("facilitate")}))):alert(m.noStart[o.state])},g=()=>{null===s&&(t.emit("restoreGame",JSON.stringify(o),(e=>{null===s&&(clearTimeout(r),p("game restore complete - game can recommence"),k(e),se())})),clearTimeout(r),r=setTimeout(g,200))},y=e=>{let a=window.prompt(m.END_WARN);a&&t.emit("testPassword",{session:o.uniqueID,pw:a},(a=>{a?(console.log("OK to end"),t.emit("endGame",s,(t=>{k(t),se(),be(d),e&&e()}))):alert("Incorrect password")}))},b=e=>{if(window.confirm(m.RESET_WARN)){const a=s.uniqueID;p(`resetting game ${a}`),t.emit("resetGame",a,(t=>{o=t,be(d),oe(),se(!0),e&&e(),(()=>{let e=localStorage;const t=["votes","collabs","renderState","roundState"];Object.keys(e).forEach((e=>{t.some((t=>e.includes(t)))&&localStorage.removeItem(e)})),e=localStorage})(),window.location.reload()}))}},k=e=>{if(s)if(e.hasOwnProperty("updateType"))switch(e.updateType){case"add":s.hasOwnProperty(e.dest)&&(s[e.dest][e.new.id]=e.new);break;case"replace":s[e.dest]=e.new;break;default:console.warn(`updateType '${e.updateType}' has no associated action; game will not be updated`)}else Object.assign(s,e);else s=Object.assign({},e),window.gameShare(s)},v=e=>{e.length>1&&console.warn("multiple score changes detected - should not be possible, check code");const t=e.map(unpackScore)[0];window.findRoundTrigger(t.round),window.renderScoreboard("insertion")};const S=t=>{const a=procVal;const n=!ke(t,"playersFull"),o=ve(t.scores);if(o.length>0&&v(o),n){if(a(t.uniqueID)===a(e())){let e=!0;if(t._updateSource){if(t._updateSource.type&&"player"===t._updateSource.type){e=!1;const a=window.clone(t),n=a.playersFull[a._updateSource.playerID];k(n?{updateType:"add",dest:"playersFull",id:n.id,new:n}:{updateType:"replace",dest:"playersFull",new:a.playersFull}),k({updateType:"replace",dest:"players",new:a.players}),k({updateType:"replace",dest:"teams",new:a.teams})}}else console.warn("no _updateSource provided, SLEDGEHAMMER METHOD - will update entire game");e&&k(t),clearTimeout(i),i=setTimeout((()=>{ne("facilitatePlayersContent"),X(),Z(),he()}),1e3),$("#roundcompleter").length>0&&$("#roundcompleter").is(":visible")&&(De(),Q())}}else console.warn("gameUpdate has not completed due to a failure at compareGames method")},T=()=>{window.open(`/presentation#${s.address.replace("/","")}`,"_blank")},O=()=>{window.open(`/fakegenerator#${s.address}`,"_blank")},I=()=>{const e=$("#contentTeams").find(".link");e.off("click"),e.on("click",(function(){t.emit("identifyPlayer",{game:s,player:$(this).attr("id").split("_")[2]})}))},D=(e,t)=>e.connected&&!t.connected?l.dir?-1:1:!e.connected&&t.connected?l.dir?1:-1:0,C=(e,t)=>e.isLead&&!t.isLead?l.dir?-1:1:!e.islead&&t.isLead?l.dir?1:-1:0,E=(e,t)=>{const a=parseInt(e.index),n=parseInt(t.index);return void 0===a||void 0===n?0:a<n?l.dir?-1:1:a>n?l.dir?1:-1:0},P=(e,t)=>{const a=parseInt(e.id.replace(/pf/g,"")),n=parseInt(t.id.replace(/pf/g,""));return void 0===a||void 0===n?0:a<n?l.dir?-1:1:a>n?l.dir?1:-1:0},R=(e,t)=>{const a=e.teamObj,n=t.teamObj;if(void 0===a||void 0===n)return 0;const o=a.title,s=n.title;return void 0===o||void 0===s?0:o<s?l.dir?-1:1:o>s?l.dir?1:-1:0},j=e=>{e.remove()},N=e=>{const t=e.closest(".widget").attr("id");j($(`#${t}`))},x=(e,t)=>{let a={},n=localStorage.getItem(e);n&&(a=JSON.parse(n)),a=Object.assign(a,t),localStorage.setItem(e,JSON.stringify(a))},q=(e,t,a)=>{const n=`#${e}`,o=$(n),r=`wid-${s.uniqueID}${n}`,i={x:t.x?t.x:0,y:t.y?t.y:0,w:t.w?t.w:0,h:t.h?t.h:0};if(0===o.length){$("#overlay").append(`<div class="widget" id="${e}"></div>`);let o=localStorage.getItem(r);o&&Object.assign(i,JSON.parse(o));let s={id:e,partialName:e};t.hasOwnProperty("data")&&(s=Object.assign(s,t.data));const l=t.data.preventTemplate?"facilitator.widget.nopartial":"facilitator.widget";i.x=i.w+i.x>window.innerWidth?window.innerWidth-i.w-40:i.x,i.y=i.h+i.y>window.innerHeight?window.innerHeight-i.h-40:i.y;const c={open:!0};t.hasOwnProperty("data")&&t.data.hasOwnProperty("launchMethod")&&(c.launchMethod=t.data.launchMethod),x(r,c),renderTemplate(e,l,s,(()=>{$(n).css({left:`${i.x}px`,top:`${i.y}px`,width:`${i.w}px`,height:`${i.h}px`});i.x,i.y;const e=$(n).find("#widgetouter"),t=$(n).find("#widgethandle"),o=$(n).find("#widgethandle").find(".widgetclose");e.css({width:"100%",height:"100%"}),o.off("click").on("click",(function(){x(r,{open:!1}),j($(n))})),$(n).draggable({handle:t,containment:"window",stop:function(){const e={x:$(this).position().left,y:$(this).position().top};x(r,e)}}),a&&a($(n))}))}},A=e=>{const a={address:s.address,type:"order",preview:!1};let n=!1;return e&&(a.force=!0),0===s.teams.length?t.emit("assignTeams",a,(e=>{"string"==typeof e?p(e,!0):(p("teams successfully assigned",!0),S(e),_("teams"),n=!0)})):p("teams already assigned",!0),n},L=e=>{const t=["players","scores","game","session"].indexOf(e,0)>-1;if(0===$(`#content${window.toCamelCase(e)}`).children().length||t)switch(e){case"session":oe(),W();break;case"game":se(),J();break;case"controls":me();break;case"facilitate":we();break;case"players":ne("contentPlayers");break;case"teams":de();break;case"scores":ce(),le();break;default:console.log("setupTab: invalid argument provided.")}},F=()=>{const e="started"===o.state,t=$("#linkGame"),a=$("#linkControls"),n=($("#linkFacilitate"),$("#linkScores"));t.prop("disabled",!e),a.prop("disabled",!e),n.prop("disabled",!e)},_=e=>{const t=`#link${toCamelCase(e)}`,a=$(t),n=a.css("color"),o="red";a.css({color:o,"background-color":"yellow"}).delay(100).animate({color:n,"background-color":"transparent"},500).animate({color:o,"background-color":"yellow"},10).delay(100).animate({color:n,"background-color":"transparent"},500).animate({color:o,"background-color":"yellow"},10).delay(100).animate({color:n,"background-color":"transparent"},500)},M=()=>{const e=$(".tabcontent:visible"),t={title:"noTab"};return e.length>0&&(t.el=e,t.title=e.attr("id").replace("tab","").toLowerCase()),t},G=()=>{setTimeout((()=>{let e=$("#clearLog"),t=$(".tablinks");e.off("click"),t.off("click"),e.on("click",(()=>{a.splice(0,a.length),f()})),t.on("click",(function(){$("#overlay").find(".widget").each(((e,t)=>{$(t).remove()})),be($(this).attr("id").replace("link",""))}));const n=d;F(),be(n)}),500)},W=()=>{p("setupSessionLinks");let e=$("#gameStart"),t=$("#sessionReset"),a=$("#gameLaunch");$(".link").off("click"),e.on("click",h),t.on("click",w),"started"!==o.state&&(a.addClass("disabled"),document.getElementById("gameLaunch")&&document.getElementById("gameLaunch").addEventListener("click",(e=>{e.preventDefault()})))},J=()=>{if(s&&"started"===s.state){["#gameReset","#makeFakes","#gameEnd","#makePres"].forEach((e=>{$(e).off("click").on("click",(()=>{switch(e){case"#gameReset":b();break;case"#makeFakes":O();break;case"#makePres":T();break;case"#gameEnd":y()}}))}))}},U=()=>{const e=$("#contentControls").find(".buttonSet").find("button");$("#roundInput");["#preview","#resize","#assign","#reset","#identify","#startRound","#completeRound","#checkRound","#slideshow","#setName","#clearConsole","#presInfo","#downloadRes","#signOut"].forEach((e=>{$(e).off("click").on("click",(()=>{const a=parseInt($("#roundInput").val());switch(e){case"#setName":const e=$("#nameInput").val();e?t.emit("sessionNameChange",{gameID:s.uniqueID,name:e}):alert("no name provided");break;case"#preview":(async()=>{const e={address:s.address,type:"order",preview:!0},a=!1;t.emit("assignTeams",e,(e=>{if("string"==typeof e);else{const t=e.persistentData.teams,n=e.teams;let o="Team breakdown Preview:\n";n.forEach(((e,a)=>{o+=`${t["t"+a].title}:  ${e.join(", ")} (${e.length} player${1===e.length?"":"s"})\n`})),a=!0}return a}))})();break;case"#resize":(()=>{const e=`game-${s.uniqueID}`,a=parseInt($("#teamInput").val());t.emit("setTeamSize",{gameID:e,n:a},(e=>{S(e)}))})();break;case"#assign":A();break;case"#reset":0===s.scores.length?t.emit("resetTeams",{address:s.address},(e=>{p("teams reset"),S(e)})):alert(m.NORESET);break;case"#identify":t.emit("identifyPlayers",s);break;case"#slideshow":B();break;case"#startRound":K(a);break;case"#completeRound":Q(a);break;case"#checkRound":const n=parseInt($("#roundInput").val());t.emit("checkRound",{gameID:s.uniqueID,round:n},(e=>{Y(e,s.persistentData[s.persistentData.rounds[n].teams])}));break;case"#clearConsole":console.clear();break;case"#presInfo":t.emit("togglePresInfo",s.address);break;case"#downloadRes":Se();break;case"#signOut":confirm("Are you sure you want to sign out of this session?")&&(document.cookie.split(";").forEach((e=>{const t=e.indexOf("="),a=t>-1?e.substring(0,t):e;document.cookie=a+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT"})),window.location.replace("facilitatorlogin"))}}))})),e.off("click").on("click",(function(){const e=$(this).parent().parent().find(".valInput"),t=parseInt(e.val());e.val("+"===$(this).html()?t+1:t-1),e.val(parseInt(e.val())<-1?-1:e.val())})),V()},V=()=>{const e=$("#facilitator-advanced"),a=e.find("#reset"),n=e.find("#launchqr"),o=e.find("#showqr"),r=e.find("#gameEnding"),i=e.find("#gameReset"),l=e.find("#sessionReset"),c=e.find("#fakeGen"),d=e.find("#playersWin"),u=e.find("#refreshAll"),p=e.find("#removeAll"),f=e.find("#allHome");a.add("#completeRound"),a.each(((e,t)=>{$(t).attr("id")&&$(t).on("click",(function(){N($(this))}))})),n.off("click").on("click",(()=>{ie()})),o.off("click").on("click",(()=>{t.emit("presentationOverlay",{type:"qr",game:s.address})})),r.off("click").on("click",(()=>{y((()=>{N(r)}))})),l.off("click").on("click",(()=>{confirm(m.SESSION_WARN)&&w((()=>{N(l),alert(m.SESSION_DONE)}))})),i.off("click").on("click",(()=>{b((()=>{N(i)}))})),c.off("click").on("click",(()=>{O()})),d.off("click").on("click",(()=>{window.open(`/dev/players#${s.address}`,"_blank")})),u.off("click").on("click",(()=>{confirm(`Are you sure you want to refresh all ${s.players.length} players browsers?`)&&ee()})),p.off("click").on("click",(()=>{confirm(`Are you sure you want to close all ${s.players.length} players browsers?`)&&te()})),f.off("click").on("click",(()=>{confirm(`This will send all ${s.players.length} players back to the home page, are you sure you want to do this?`)&&ae()}))},H=async(e,a)=>{t.emit("requestCSV",e,(e=>{try{const t=new Blob([e],{type:"text/csv"}),n=document.createElement("a");n.href=window.URL.createObjectURL(t),n.download=`${a}.csv`,document.body.appendChild(n),n.click(),document.body.removeChild(n)}catch(e){console.error("Error:",e)}}))},z=e=>{const a=l,n=$(`#${e||"contentPlayers"}`),o=n.find(".listSort"),r=n.find(".makeLead"),i=n.find(".reassign"),c=n.find(".refresh"),d=n.find(".remove"),m=(n.find(".rollover"),n.find(".warning"));o.off("click").on("click",(function(){a.dir=a.prop!==this.textContent||!a.dir,a.prop=this.textContent,ne(e);const t=o.filter((function(){return $(this).text().trim()===a.prop})).index();$(o[t]).addClass("highlight")})),r.off("click").on("click",(function(){const e=$(this).attr("id").split("_").splice(1),a={game:s.uniqueID,team:parseInt(e[0]),player:e[1]};t.emit("makeLead",a)})),i.off("click").on("click",(function(){const e=$(this).attr("id").split("_").splice(1),a=parseInt(e[0]),n={game:s.uniqueID,team:a,player:e[1]},o=s.persistentData.teamsArray;if(0===s.teams[a].indexOf(e[1])&&2!==o[a].type)return void alert("Cannot reassign a team lead");let r="",i=[];o.forEach((e=>{e.id!=a&&(i.push(e.id),r+=`\n${e.id} ${e.title}`)}));let l=prompt(`Type the NUMBER of the team you would like to reassign ${e[1]} to:${r}`);if(l)if(isNaN(parseInt(l)))alert("You need to enter the number for the team you would like to rassign to, please try again.");else if(l=parseInt(l),i.indexOf(l)>-1){const a=confirm(`You are about to move ${e[1]} to the ${o[l].title} team, is this OK?`);n.newTeam=l,a&&t.emit("reassignTeam",n)}else alert(`Not possible, the allowed set of options is ${i}.`)})),c.off("click").on("click",(function(){const e=$(this).attr("id").split("_").splice(2),a=s.playersFull[`${e}`],n=a?a.socketID:"",o={game:s.uniqueID,player:a,socketID:n};t.emit("refreshClient",o)})),d.off("click").on("click",(function(){let e;const a=$(this).attr("id").split("_")[2],n={game:s.uniqueID,player:a};if(console.log(n),s.playersFull.hasOwnProperty(`${a}`)){const t=s.playersFull[`${a}`];if(t.isLead&&(e=confirm("It is risky to remove a team lead, consider assigning a new lead first. Click OK if you are sure you want to remove the player."),!e))return;t.connected&&alert("Note: removing a currently connected player may cause unexpected results"),t.teamObj&&alert("Note: removing a player already assigned to a team may cause unexpected results")}e=confirm(`Are you absolutely sure you want to remove player ${a}`),e&&t.emit("removePlayer",n,(e=>{e.hasOwnProperty("err")&&alert(`Cannot remove ${a}: ${e.err}`)}))})),m.off("click").on("click",(function(){const e=$(this).closest("tr").index()-1;alert(list[e].warningMessage)}));n.find(".material-icons");n.find(".material-icons:disabled").removeAttr("title")},B=()=>{q(c,{x:400,y:200,w:600,h:600},(()=>{window.slideContolsInit(s)}))},K=(e,a)=>{const n=s.teams,o=s.players,r=void 0===a||a;e=window.justNumber(e);const i=window.justNumber(s.round),l=s.round.toString().indexOf("*",0)>-1||0===i,c=e-i===1;let d=t.emit("checkDevMode",(e=>{})),m=`Cannot start round ${e}:\n`;return 0===o.length&&e>0?(m+="no players connected, cannot start round",d=!1):0===n.length&&e>0?(m+="teams not yet assigned, must wait for allocation",d=!1):l&&i>0&&i===e?(m+="round is already completed",d=!1):e===i?(m+="round already in progress",d=!1):l?c?d=!0:m+="gap between rounds is not exactly 1, cannot continue":(m+="current round incomplete, must wait for completion",d=!1),p(d?`round ${e} started successfully`:m,!0),r&&(ae(),t.emit("startRound",{gameID:s.uniqueID,round:e,ok:d})),d},Y=(e,t)=>{let a="Team submitted score:\n\n";t.forEach(((t,n)=>{a+=`${t.title}? ${e[n]}\n`})),alert(a)},Q=()=>{t.emit("getGame",s.address,(e=>{k(e);const t=window.justNumber(s.round),a=s.playersFull;if($.isEmptyObject(a))alert("Can't complete this action, game.playersFull is not defined. Try reconnecting any fake player clients.");else if(t>0){const e=s.persistentData.rounds[t],a=(e.submissions,s.persistentData[e.teams]),n=filterScorePackets(s.scores.map(unpackScore),"round",e.n);let o=[];const r={teams:[],players:[],scorers:[]};1===e.type?o=a:a.forEach((e=>{s.teams[e.id].forEach((e=>{o.push(s.playersFull[e])}))})),o.forEach((t=>{const a=1===e.type?{prop:"src",val:t.id}:{prop:"client",val:justNumber(t.id)};0===filterScorePackets(n,a.prop,a.val).length&&r.scorers.push(Object.assign({flag:1===e.type?t.title:`${t.teamObj.title} ${t.id}`},t))})),$("#modal").modal({closeExisting:!0}),r.isLead=!0,r.currentRoundComplete=!1,r.scorers.length>0?renderTemplate("modaltheatre","facilitator.roundcompleter",r,(()=>{let t=$(".modtablinks");t.off("click"),t.on("click",(function(){const t={isLead:!0,currentRoundComplete:!1},a=$(this).attr("id").replace("link_","");1===e.type?t.teamObj=s.persistentData.teams[`t${a}`]:s.teams.forEach(((e,n)=>{e.indexOf(a,0)>-1&&(t.teamObj=s.persistentData.teams[`t${n}`])}));const n=s.playersFull[1===e.type?s.teams[t.teamObj.id][0]:a];t.game=s,n.teamObj=Object.assign({},t.teamObj),$("#formname").html(t.teamObj.title),t.dynamicTeamData=window.createDynamicTeamData(),renderPartial("formzone",`game-${e.template}`,t,(()=>{$(".resources-btn").css({width:"30px",height:"30px","background-color":"green"}),1===e.type?e.n===u?window.setupCollaborationControl(n):window.setupAllocationControl(n):window.setupVoteControl(n)}))}))})):$("#modaltheatre").html(`Round ${t} is complete, no further input needed.`)}else alert("No round currently active.")}))},X=()=>{const e=s.playersFull,t=new Array(s.mainTeamSize*s.persistentData.mainTeams.length+s.persistentData.secondaryTeams.length).fill("no");let a=0;Object.values(e).forEach((e=>{e.connected&&(a<t.length&&(t[a]="yes"),a++)})),renderTemplate("playermeter","facilitator.playermeter",{total:t,required:t.length,connected:a},(()=>{}))},Z=()=>{const e=s.persistentData.rounds,t=s.presentation.slideData.slideList,a=[];t.forEach((t=>{if(t.hasOwnProperty("action")&&t.action.includes("startRound")){const n=t.action.split(":")[1],o={round:n,titleFull:t.title,title:t.title.replace(/\([^)]*\)/g,""),data:e[n],current:justNumber(s.round)===justNumber(n),complete:s.round.toString().includes("*")&&justNumber(s.round)===justNumber(n)||justNumber(s.round)>justNumber(n)};a.push(o)}})),renderTemplate("facilitateRoundsContent","facilitator.rounds",a,(()=>{}))},ee=()=>{t.emit("refreshAllClients",s.address)},te=()=>{t.emit("getGame",s.address,(e=>{e.players.forEach((e=>{const a={game:s.uniqueID,player:e,alsoClose:!0};t.emit("removePlayer",a,(e=>{e.hasOwnProperty("err")&&console.warn(`Could not remove: ${e.err}`)}))}))}))},ae=()=>{t.emit("sendClientsHome",s.address)},ne=e=>{if(s){let t=s.players.slice(0);const a=Object.assign({},s.playersFull);t.forEach(((e,a)=>t[a]={id:e,connected:!1}));let n=t;n.forEach(((e,t)=>{a.hasOwnProperty(e.id)?n[t]=a[e.id]:e.id.hasOwnProperty("id")&&(a.hasOwnProperty(e.id.id)?n[t]=a[e.id.id]:n[t]=e.id);if(n[t].teamObj){const e=n[t].teamObj.title;n[t].teamObj.titleClip=`${e.substr(0,8)}${e.length>8?".."+e.substr(e.length-1,1):""}`}}));const o=l;switch(o.prop){case"index":n.sort(E);break;case"ID":n.sort(P);break;case"connected":n.sort(D);break;case"team":n.sort(R);break;case"isLead":n.sort(C)}n=(e=>(e.forEach(((t,a)=>{!t.connected&&t.isLead&&(e[a].warning=!0,e[a].warningMessage="Team lead is disconnected, consider assigning new lead if they do not reconnect shortly.")})),e))(n),clearTimeout(o.timeout),renderTemplate(e,"playerlist",n,(()=>{z(e)}))}},oe=()=>{const e="contentSession";window.setupObserver(e,(()=>{W()})),window.renderTemplate(e,"sessionCardFacilitator",o,(()=>{W()}))},se=e=>{const t="contentGame";window.setupObserver(t,(()=>{J()}));let a={game:window.copyObjectWithExclusions(s,["persistentData","playersFull","scorePackets","detailedScorePackets","teamObjects","presentation","updateSource","teams","players","scores","values"])};a.gameInactive="started"!==a.game.state,e?$(`#${t}`).html(""):window.renderTemplate(t,"gameCard",a,(()=>{}))};const re=()=>{q("facilitator-scoreboard",{x:100,y:100,w:1100,h:290,data:{preventTemplate:!0,launchMethod:"launchScoreboard"}},(e=>{(()=>{const e="facilitator-scoreboard";renderTemplate(`widgetinner${e}`,"facilitator.scoreboard",{game:s},(()=>{const t=$(`#widgetinner${e}`);$(`#widgetinner${e}`).parent(),t.find("div"),window.initScoreboard(s.address,"dashboard",s),window.renderScoreboard("insertion")}))})()}))},ie=()=>{q("facilitator-qrs",{x:100,y:100,w:420,h:270,data:{preventTemplate:!0,launchMethod:"launchQRs"}},(e=>{(()=>{const e="facilitator-qrs";renderTemplate(`widgetinner${e}`,"facilitator.qrs",{game:s},(()=>{const t=$(`#widgetinner${e}`);$(`#widgetinner${e}`).parent(),t.find("div"),t.find(".qrcode").css({width:"200px",float:"left"})}))})()}))},le=async()=>{},ce=async()=>{},de=()=>{let e={};if(s){const t=s.persistentData.teams,a=s.teams;Object.values(t).forEach(((t,n)=>{t.hasOwnProperty("id")&&a[n]&&(e[t.id]={name:t.title,team:a[n].toString(),players:a[n]})})),window.renderTemplate("contentTeams","teamsCard",e,(()=>{I()}))}},me=()=>{if(s){const e=s.teams.length>0,t={disableAssignTeams:e,disableDownload:"4*"!==s.round,game:s};window.renderTemplate("contentControls","facilitator.controls",t,(()=>{U(),e&&de(),localStorage.getItem(c)&&B()}))}else console.log("no game")},ue=()=>{const e=Object.assign({hasName:void 0!==o.name,playersConnected:o.players.length>0,playerCount:o.players.length},o);renderTemplate("contentFacilitate","facilitator.start",e,(()=>{window.loadCSS("facilitator.intro"),window.facIntroInit(e)}))},pe=async()=>{await(async e=>{if(s){s.scores;const a=s.persistentData.mainTeams,n=[];let o=await emitWithPromise(t,"getTotals1",s.uniqueID);o&&(o=JSON.parse(o),o=roundAll(o)),t.emit("getScorePackets",s.uniqueID,(t=>{a.forEach((e=>{const a=t.filter((t=>t.dest===e.id)),o={team:`${e.title.substr(0,10)}${e.title.length>10?"..":""}`,id:e.id,r1:a.filter((e=>1===e.round)),r2s5:a.filter((e=>2===e.round)).filter((e=>5===e.src)),r2s6:a.filter((e=>2===e.round)).filter((e=>6===e.src)),r2s5Summary:{total:0,average:0,scores:[]},r2s6Summary:{total:0,average:0,scores:[]}};o.r1Summary={total:0===o.r1.length?0:o.r1[0].val},o.r2s5.forEach((e=>{o.r2s5Summary.total+=e.val,o.r2s5Summary.scores.push(e.val)})),o.r2s6.forEach((e=>{o.r2s6Summary.total+=e.val,o.r2s6Summary.scores.push(e.val)})),o.r2s5Summary.average=0===o.r2s5.length?0:o.r2s5Summary.total/o.r2s5.length,o.r2s6Summary.average=0===o.r2s6.length?0:o.r2s6Summary.total/o.r2s6.length,o.r1Total=o.r1Summary.total,o.r2s5All=0===o.r2s5Summary.scores.length?"n/a":o.r2s5Summary.scores.join(","),o.r2s5Av=o.r2s5Summary.average,o.r2s6All=0===o.r2s6Summary.scores.length?"n/a":o.r2s6Summary.scores.join(","),o.r2s6Av=o.r2s6Summary.average,o.r2Total=o.r2s5Summary.average+o.r2s6Summary.average,o.grandTotal=o.r2Total*o.r1Total,n.push(o)})),sortBy(n,"grandTotal",!0),e&&e(n)}))}else e&&e("nuffink")})((e=>{console.log("scores?"),console.log(e)}));console.log("renderOutro"),console.log(s),console.log(o),renderTemplate("contentFacilitate","facilitator.end",o,(()=>{$("#adminGameReset").off("click").on("click",(()=>{let e=window.prompt("Enter admin password");e&&t.emit("testPassword",{adminOnly:!0,session:o.uniqueID,pw:e},(a=>{t.emit("resetEndedGame",{pw:e,session:o.uniqueID},(e=>{if("object"==typeof e){o=Object.assign(o,e);const t=window.mapSessionToGame(e,s);k(t),we()}else alert(a?"OK to reset, but a session object has not been returned.":"Cannot reset, password incorrect.")}))}))}))}))},fe=e=>{let t=e.presentation.slideData.slideList.slice(0);t.forEach(((e,a)=>{e._titleSimple=e.title,e.title=e.title.replace(/\(/gm,'<span class="hint">(').replace(/\)/gm,")</span>"),t[a]=window.reorderObject(e,"_titleSimple")}));const a=t.filter((e=>!e.exclude));renderTemplate("slidelist","facilitator.slidelist",a,(()=>{$("#tabFacilitate").css({height:"700px"}),window.slideContolsInit(e),window.updateSlideList()}))},we=()=>{if(s)"ended"===s.state?pe():"pending"===s.state?ue():(s.urlPresentation=`${s.base}/presentation#${s.address.replace("/","")}`,renderTemplate("contentFacilitate","facilitator.facilitate",s,(()=>{fe(s),ne("facilitatePlayersContent");$("#facilitateSlideshow").find("#makePres").off("click").on("click",(()=>{T()})),X(),Z();$("#openAdvanced").off("click").on("click",(()=>{q("facilitator-advanced",{x:100,y:100,w:500,h:230,data:{preventTemplate:!0,launchMethod:"launchAdvanced"}},(e=>{he()}))})),window.createCopyLinks(),(async()=>{renderTemplate("facilitateScoresContent","scoreslaunch",{},(()=>{$("#facilitateScoresContent").find("button").off("click").on("click",(()=>{re()}))}))})()})));else switch(o.state){case"pending":ue();break;case"ended":pe()}},he=async()=>{const e="facilitator-advanced",t={game:s},a=await window.checkDevMode();t.teamsAssigned=s.teams.length>0,t.roundActive=s.round>0,t.scoresSubmitted=s.scores.length>0,t.preventTemplate=!0,t.disableDownload="4*"!==s.round,t.isDev=a,renderTemplate(`widgetinner${e}`,"facilitator.advanced",t,(()=>{const t=$(`#widgetinner${e}`),a=$(`#widgetinner${e}`).parent(),n=t.find("div");a.css({height:`${n.height()+50}px`}),U()}))},ge=async()=>{p(`initSession, session state? ${o.state}`),G(),(()=>{const e=Object.keys({...localStorage}).filter((e=>e.includes("wid")));e&&e.forEach((e=>{const t=JSON.parse(localStorage.getItem(e));t.hasOwnProperty("launchMethod")&&setTimeout((()=>{"launchScoreboard"===t.launchMethod&&t.open&&re()}),1e3)}))})(),"started"===o.state&&(p("session already started, restore"),g())},ye=e=>{fetch("/admin/getSession?sessionID="+e,{method:"POST",headers:{"Content-Type":"application/json"}}).then((e=>{if(!e.ok){const e="Failed to get session data";throw p(e),new Error(e)}return e.json()})).then((e=>{o=e,o.base=window.location.origin,o.localIP&&(o.localIP=window.procVal(o.localIP),o.localIP&&(o.base=o.base.replace("localhost",o.localIP))),o.playerURL=`${o.base}${o.address}`,p("session data found:"),p(`${JSON.stringify(e).substr(0,45)}...`),ge()})).catch((e=>{console.error("Error:",e)}))},be=e=>{const t=M();e!==t.title&&t.hasOwnProperty("el")&&$(`#content${window.toCamelCase(t.title)}`).html(""),$(`#content${window.toCamelCase(t.title)}`).html("");const a=`${e.substr(0,1).toUpperCase()}${e.substr(1).toLowerCase()}`,n=$(".tabcontent"),o=$(".tablinks"),s=$(`#tab${a}`),r=$(`#link${a}`);n.hide(),o.removeClass("active"),s.show(),r.addClass("active"),L(e.toLowerCase()),F()};let $e=[];window.showChangeReport=()=>{$e.filter((e=>!e.prop.includes("warning"))).forEach((e=>{console.log(`${e.player} ${e.prop} from ${e.old} to ${e.new}`)}))};const ke=e=>deepEqual(e,s),ve=e=>{const t=s?s.scores:[],a=e,n=[...t],o=[...a];return n.filter((e=>!a.includes(e))).concat(o.filter((e=>!t.includes(e))))},Se=async()=>{const e=s.persistentData.mainTeams,a=await emitWithPromise(t,"getTotals4",s.uniqueID),n=[];a&&(a.forEach(((t,a)=>{const o={team:t.team,"Player Resources":t.self};o["Public Voice Resources 1"]=roundNumber(t.pvR2Total,3),e.forEach((e=>{o[e.abbr]=e.id===a?"x":t.summary_r3[e.id]})),o["Total Player Resources"]=t.total,o["Public Voice Resources 2"]=roundNumber(t.pvR4Total,3),o["Total Score"]=t.gtRound,n.push(o)})),n.forEach((e=>console.log(e))),H(n,`sus_${s.address.replace("/","")}_results`))},Te={rAssignTeams:A},Oe=async e=>{if(!s)return;const a=s.presentation.slideData.slideList[e];let n=!0,o=!1,r=null;try{if(!a)throw new Error("no slide");if(!a.hasOwnProperty("action"))throw new Error("no action");if(r=a.action,r.includes("startRound")){const e=parseInt(r.split(":")[1]);o=!0,n=K(e)}if(r.toLowerCase().includes("assignteams")){o=!0;n="object"==typeof await emitWithPromise(t,"assignTeams",{address:s.address,type:"order",preview:!0})&&0===s.teams.length}}catch(e){}return{tested:o,test:n,ac:r}};const Ie=()=>{const a=e();window.socketShare(t,"fdb_socket"),p(`sessionID: ${a}`),a&&ye(a)};t.on("test",(()=>{console.log("test")})),t.on("gameUpdate",(e=>{S(e)})),t.on("onGameRestored",(e=>{})),t.on("playerUpdate",(e=>{})),t.on("teamsAssigned",(e=>{s.teams=e.teams,s.playersFull=e.playersFull,ne("facilitatePlayersContent"),fe(e)})),t.on("scoreSubmitted",(e=>{})),t.on("presentationSlideUpdated",(e=>{})),t.on("onShowSlide",(e=>{(async e=>{const t=e.ref;await Oe(t)})(e)})),t.on("gameWarning",(e=>{alert(e.warning)})),t.on("gotoNext",(()=>{console.log("facilitatorDashboard hears gotoNext"),window.pEvent("next")})),t.on("roundComplete",(e=>{p(`yes, round ${e.round} complete`,!0),e.round>0&&e.persistentData.rounds[e.round].hasOwnProperty("completionMsg")})),renderTemplate=window.renderTemplate,renderPartial=window.renderPartial,procVal=window.procVal,window.showGame=()=>s,window.showTeams=()=>{let e="no teams to show";return s.teams&&(e=s.teams),e},window.startGame=h,window.getSessionID=e,window.showScores=async()=>{let e=await emitWithPromise(t,"getTotals1",s.uniqueID);return e?(console.log(JSON.parse(e)),e):"nothing to show"},window.facilitatorSlideChange=e=>{(()=>{const e=$("#facilitateMessage");e&&e.html("")})();const t=s.presentation.slideData.slideList[e.currentSlide];t.action&&(t.action.includes("startRound"),t.action.includes("showRound"),Te.hasOwnProperty(t.action)&&Te[t.action]())},window.renderFacilitate=we,window.slideTest=Oe;const De=()=>{$("#modal").modal("close")};window.closeModal=De,window.devCompleteR1=()=>{s.persistentData.mainTeams.forEach(((e,a)=>{console.log(a,Math.round(5*Math.random()));const n={scoreCode:{src:a,dest:a,val:Math.round(5*Math.random())},game:s.uniqueID,client:a};t.emit("submitScore",n,(e=>{window.setupAllocationControl()}))}))},null===e()&&window.location.replace("facilitatorlogin")}));
