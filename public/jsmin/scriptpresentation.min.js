document.addEventListener("DOMContentLoaded",(function(){const e="insertion",t={qrdark:"#ffffff88",qrlight:"#0d140d44"},o={qrdark:"#ffffff99",qrlight:"#0d140d99"};let n=null,s=null,a=null,r=null,i=!0,l=null,c=null;const d=()=>{const e=window.location.hash.split("?")[0].replace("#","");return n=e,e};let u=null;const m=()=>{u=io("",{query:{role:"presentation",id:d()}}),u.on("setGame",(e=>{if(e&&p(e),s){const e=s.presentation.slideData.slideList[s.presentation.currentSlide];e&&k(e),f(),localStorage.getItem(`${h()}-watch`)&&v(localStorage.getItem(`${h()}-watch`)),window.initScoreboard(d(),"presentation",s)}})),u.on("gameReady",(e=>{p(e)})),u.on("gameUpdate",(e=>{w(e)})),u.on("scoresUpdated",(e=>{N(e)})),u.on("scoreUpdate",(e=>{_(e)})),u.on("showSlide",(e=>{k(e)})),u.on("updateProperty",(e=>{console.log("updateProperty",e);const t={};t[e.prop]=e.val,Object.assign(s.presentation,t),console.log(s.presentation)})),u.on("refreshWindow",(()=>{window.location.reload()})),u.on("onGameRestored",(e=>{A(e)})),u.on("toggleOverlay",(e=>{let t=null;if("qr"===e)t=e;else console.log(`no overlay of type ${e} specified`);if(t){const e=$("#facilitatoroverlay"),n=`overlay_${t}`;if(e.find(`#${n}`).is(":visible"))e.fadeOut();else{e.show(),e.css({display:"block"});const t=e.find(".ocontent");t.attr("id",n),t.addClass("qr"),renderTemplate(n,`qr/qrcode-${s.uniqueID}`,o)}}})),u.on("roundComplete",(()=>{const e=this[`showRound${s.round}`];Boolean(e)&&"function"==typeof e&&e()})),u.on("togglePresInfo",P),u.on("preparePresentation",(()=>{}))},p=e=>{s=e},g=()=>l||"",w=e=>{r&&s[r].toString()!==e[r].toString()&&E(),s.round!==e.round&&v("scores"),p(e)},f=()=>{c=`presStore-${s.address}`},h=()=>c,v=e=>{r=e,localStorage.setItem(`${h()}-watch`,e)},y=(e,t)=>e.sort(((e,o)=>{const n=e[t],s=o[t];return n<s?-1:n>s?1:0}));const b=()=>{T(1)},S=()=>{T(3)};let D=0;const T=t=>{v("scores"),u.emit("getGame",`${s.uniqueID}`,(o=>{w(o);const n=filterScorePackets(s.scores.map((e=>unpackScore(e))),"round",t);u.emit("getScores",`game-${s.uniqueID}`,(a=>{(a=filterScorePackets(a,"round",t)).length,o.values.length;const r=((e,t)=>{const o=s.persistentData.teamsArray;let n=[],a=s.values,r=t||s.scores;a=a.filter((t=>t.round===e)),r=filterScorePackets(r,"round",e);let i=r.slice(0);a&&r&&(a=y(a,"team"),r=y(r,"src"),a.forEach(((e,t)=>{const s={team:e.team,title:o[e.team].title,action:e.action,description:e.description,value:r[t].val,teamObj:o[e.team]};n[t]=s})));let l=[];return i=filterScorePackets(i,"round",e),i.forEach(((e,t)=>{const n=a.find((t=>t.team===e.src));if(n){const t={team:e.src,title:o[e.src].title,action:n.action,description:n.description,value:e.val,teamObj:o[e.src]};l.push(t)}else console.warn("no vl found")})),l})(t,a);if(!r)return console.log("fail due to values not being in place yet, return and run again after short delay"),D++<5?void setTimeout((()=>{T(t)}),100):void 0;D=0;const i={allScores:r};s.persistentData.teamsArray.forEach(((e,t)=>{i[`card_${t}`]={id:e.id,title:e.title,displayColour:e.displayColour,icon:`card_icon_${e.abbr}`}})),r.forEach((e=>{const t=i[`card_${e.team}`];t.action=e.action,t.description=e.description,t.value=e.value})),renderTemplate(e,"slides/showround1",i,(()=>{r.forEach((e=>{const t=filterScorePackets(n,"src",e.team).length>0,o=$(`#stakeholder_card_${e.team}`).find(".leaf");t?o.show():o.fadeIn()}))}))}))}))};window.tester=T;const I=t=>{removeTemplate(e,(()=>{console.log("render with",t),renderTemplate(e,"slides/video_player",t,(()=>{C(t),t.srcRef,a=$("#videoPlayer"),setTimeout((()=>{}),500)}))}))};var O;const q=()=>{O.setVolume(1),setTimeout(q,4e3)};const P=()=>{const e=`presDev-${s.address}`;localStorage.getItem(e)&&(i=localStorage.getItem(e)),i=procVal(i),i=!i,localStorage.setItem(e,i),j()},j=e=>{const t=`presDev-${s.address}`;localStorage.getItem(t)&&(i=localStorage.getItem(t)),i=procVal(i),Boolean(e)||(e=s.presentation.slideData.slideList[s.slide]);let o=window.location.hash.split("?")[1];o&&(o=Object.fromEntries(new URLSearchParams(o)),o.hasOwnProperty("dev")&&(isDev=procVal(o.dev)));const n=$("#devoverlay");i?n.length>0&&(n.show(),n.is(":visible")&&(n.html(""),renderTemplate("devoverlay","presentation.devinfo",e,(()=>{n.hide()})))):n.hide()},C=e=>{const t={gameID:s.uniqueID};let o=null;if(e.hasOwnProperty("action")){if(e.action.includes(":")){o=e.action;const n=e.action.split(":");e.action=n[0],t.actionArg=n[1]}window[e.action]&&(window[e.action](t),o&&(e.action=o))}},k=o=>{if(console.log("showSlide",window.clone(o)),j(o),(e=>{l=Object.assign({},e)})(o),console.log("currentSlideObject set to ",o),console.log("getCurrentSlide returns:",R()),o.gameAddress=s.address,"video"===o.type)I(o);else if("image"===o.type)(t=>{removeTemplate(e,(()=>{renderTemplate(e,"slides/imageslide",t,(()=>{}))}))})(o);else if("slide"===o.type){const n=`slides/${o.slide}`;renderTemplate(e,n,s,(()=>{const e={gameID:s.uniqueID};C(o),Object.assign(e,t),u.emit("slideUpdated",o)}))}else renderTemplate(e,"slides/notready",o,(()=>{}))},E=()=>{const e=l;e&&e.action&&C(e)},R=()=>{const e=s.presentation,t=e.currentSlide;return e.slideData.slideList[t]},N=e=>{s.scores=e,b()},_=e=>{},A=()=>{window.location.reload()},V=()=>{let e=["shift","d","b"],t=0;$(document).on("keydown",(o=>{o.key.toLowerCase()===e[t]?(t++,t===e.length&&($("#devoverlay").toggle(),t=0)):t=0}))};setTimeout((()=>{V(),m()}),500),renderTemplate=window.renderTemplate,getTemplate=window.getTemplate,this.showRound1=b,this.showRound3=S,window.showScores=()=>{u.emit("getScores",`game-${s.uniqueID}`,(e=>{renderTemplate("insertion","slides/showscores",e)}))},window.showValues=()=>{u.emit("getAllValues",`game-${s.uniqueID}`,(e=>{const t=Object.assign({},e);console.log(s);for(let e in t)t[e].teamTitle=s.persistentData.teamsArray[t[e].team].title;const o=Object.values(t);o=y(o,"team"),renderTemplate("insertion","slides/showvalues",e)}))},window.showRound1=b,window.showRound3=S,window.showGameQR=e=>{e=Object.assign(e,t),renderTemplate("qr",`qr/qrcode-${s.uniqueID}`,e,(()=>{}))},window.showCollaboration=()=>{console.log("showCollaboration");filterScorePackets(s.scores.map((e=>unpackScore(e))),"round",4);const t={},o=s.persistentData.teamsArray,n=s.persistentData.mainTeams.length;o.forEach(((e,o)=>{if(o<n){const o=Object.assign({},e);t[`card_${e.id}`]=o}})),u.emit("getGame",`${s.uniqueID}`,(n=>{u.emit("getScores",`game-${s.uniqueID}`,(n=>{const a=(e=>{console.log("prepCollaborations");const t=s.persistentData.teamsArray,o=s.values;let n=[],a=e||s.scores;a=filterScorePackets(a,"round",4);let r=a.slice(0);return r=filterScorePackets(r,"round",4),r.forEach((e=>{const s=o.find((t=>t.team===e.src)),a={team:e.src,title:t[e.src].title,action:s.action,description:s.description,value:e.val,teamObj:t[e.src]};n.push(a)})),console.log(n),n})(n),r={},i=window.getScoresSummary(),l=(s.values.filter((e=>1===e.round)),s.values.filter((e=>3===e.round)));for(var c in Object.entries(i).forEach(((e,t)=>{const n=e[1].collScores;n.forEach(((e,t)=>{n[t]={value:"object"==typeof e?e.val:"",displayColour:o[t].displayColour}})),n.splice(t,1);const s=l.filter((e=>e.team===t))[0],a=Object.assign(o[t],{votes:n,action:s.action,description:s.description});r[`card_${t}`]=a})),t){const e=window.justNumber(c);if(t[c]=a[e],t[c]){const e=JSON.parse(JSON.stringify(t[c]));t[c].displayColour=e.teamObj.displayColour,t[c].id=e.teamObj.id,t[c].votes=[],a.forEach((e=>{if(e.team!==t[c].team){const o={displayColour:e.teamObj.displayColour,value:e.value};t[c].votes.push(o)}}))}}console.log("go render",r),renderTemplate(e,"slides/showround4",r,(()=>{}))}))}))},window.renderTotals=async e=>{u.emit("getGame",`${s.uniqueID}`,(t=>{p(t);const o=$($(".barchart").find("tr")[0]).find(".bar"),n=($($(".barchart").find("tr")[1]).find(".bar"),{t2030:"total2030",t2040:"scorePlusShare",tfinal:"grandTotal"}),s=window.getScoresSummary(),a=Object.values(s).map((t=>t[n[`t${e.actionArg}`]]));const r=100/a.map((e=>Math.abs(e))).sort(sortNumber)[0];$(".totalNum").html(""),o.each(((e,t)=>{let o=a[e]*r,n=Math.abs(o);o<0?o=0:n=0;const s=o/100*$(t).parent().height();$(t).parent().height();$(t).animate({height:`${o}%`});const i=0===n?$(`#tn${e}Pos`):$(`#tn${e}Neg`);i.html(roundNumber(a[e],1));const l=0===n?s+50:s;0===justNumber(i.html())?i.css({bottom:"40px"}):i.animate({bottom:`${l}px`}),$(`#b${e}Neg`).animate({height:`${n}%`})}))}))},window.renderTotalsTable=()=>{window.renderScoreboard("totals_table","presentation.results",(()=>{window.getScoresSummary();window.updateScoreTable()}))},window.unmute=()=>{const e=document.getElementById("videoplayerframe"),t=e.contentWindow.document.getElementsByTagName("iframe")[0].contentWindow;console.log("the unmute:"),console.log(e),console.log(t),t.postMessage('{"msg":"iframeUnmute","source":"PanoptoEmbed","id":"player","data":""}',"https://cranfield.cloud.panopto.eu")},window.maxVol=()=>{O.setVolume(1)},window.ensureAudio=q,window.showGame=()=>{console.log(s.presentation)},window.getVidID=()=>{let e=null;return g().hasOwnProperty("srcRef")&&(e=g().srcRef),e},window.onVideoEnd=()=>{const e=s.presentation.autoplay;console.log("yes, a video has ended, ap:",e);const t=R();if("loop"===t.behaviour)k(t);else e&&u.emit("gotoNextSlide",{gameID:s.uniqueID,address:s.address})},window.getCurrentSlide=R,window.videoPosition=e=>{e.perc=e.now/e.total*100,e.address=s.address,e.slideID=l.ref,u.emit("videoPositionUpdate",e)}}));
