document.addEventListener("DOMContentLoaded",(function(){const e=window.location.hash.replace("#","").replace(/\?.*$/,""),t=sessionStorage.getItem("clientId")||crypto.randomUUID();sessionStorage.setItem("clientId",t);const n=io("",{query:{role:"fakegen",type:"fakeGenerator",id:e,clientId:t}}),o=$("#num"),s=1,a=40;let l,r,i,c,d=null;parseInt(window.getQueries().start||0);const f=()=>{sessionStorage.setItem(u(),JSON.stringify(l))};const p=()=>{const t=l.filter((e=>e.s===c)),n=t[0];if(t.length){const t=`pf${40*i+n.n}`,o=`${e}?fake=true&fid=${t}`;n.o=!0,n.s=1,n.p=t,f(),window.open(o,"_blank"),setTimeout(p,300+400*Math.random())}else $("#fakeForm").find("button").attr("disabled",!1)},g=()=>{if(!d)return 0;if(0===d.players.length)return 0;return Math.max(...d.players.map((e=>window.justNumber(e))))},m=()=>{(()=>{const e=g();if(!isNaN(e)&&null!==d){const t=`${window.isLocal()?d.localDevAddress:window.location.origin}${d.address}?fake=true&fid=pf${e+1}`;$("#qroverlay").html(""),n.emit("getQrString",t,(e=>{console.log(`update QR to ${t}`);const n=`${t}${e}`;$("#qroverlay").html(n)}))}})()},u=()=>`fakegen-${e}-${i}-fakes`,h=()=>{l.length||console.log("no fakes exist")};n.on("checkOnConnection",(t=>{i=t.fakegenID,l=sessionStorage.getItem(u())||[],l="string"==typeof l?JSON.parse(l):l;const o=document.title.replace(/^\(\d+\)\s*/,"");document.title=`(${i}) ${o}`;const s=$("H1").html().replace(/^\(\d+\)\s*/,"");$("H1").html(`(${i}) ${s}`),$("H1").css({"font-size":"2rem"}),n.emit("getGame",e,(e=>{d=e,m()}))})),n.on("gameUpdate",(e=>{d=e,m()})),n.on("playerRemoved",(e=>{const t=l.filter((t=>t.p===e.player))[0];t.o=!1,t.s=2,console.log("playerRemoved",e),h(),f()})),window.launchFakes=e=>{e.preventDefault(),$("#fakeForm").find("button").attr("disabled",!0),r=parseFloat($("#num").val());const t=l.length?l[l.length-1].n:0;for(let e=0;e<r;e++)l.push({n:e+t+1,o:!1,s:0});h(),c=0,p()},window.reopenFakes=e=>{e.preventDefault(),h();const t=l.filter((e=>2===e.s));if(t.length>0){confirm(`This will reopen ${t.length} fake player${t.length>1?"s":""}, are you sure you want to do this?`)&&(c=2,p())}else alert("no closed fakes")},window.clearFakes=e=>{e.preventDefault();l.filter((e=>!e.o));l=l.filter((e=>e.o)),sessionStorage.setItem(u(),JSON.stringify(l)),h()},window.checkInputType=()=>{o.val()<s&&o.val(s),o.val()>a&&o.val(a)}}));
