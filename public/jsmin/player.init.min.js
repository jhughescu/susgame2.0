import{onGameUpdate,onPlayerUpdate,updateGame}from"./player.game.js";import{render,identifyPlayer,updateRenderState}from"./player.view.js";import{player,onPlayerUpdate as onPlayerStateUpdate,game}from"./player.state.js";import{initSocket,getSocket}from"./player.socket.js";import{getAppID,registerClearStorage}from"./player.storage.js";import{}from"./player.controller.js";document.addEventListener("DOMContentLoaded",(function(){const e=getAppID();let a,o,t,r=window.getQueries();const n="true"===r.fake,l=()=>{a=initSocket(),a.on("gameUpdate",onGameUpdate),a.on("playerUpdate",onPlayerUpdate),a.on("playerConnect",(()=>m())),a.on("identifyPlayer",(()=>identifyPlayer(t,o))),a.on("identifySinglePlayer",(e=>{e===player.id&&identifyPlayer()})),a.on("forceRefresh",(()=>window.location.reload())),a.on("forceClose",(()=>window.close())),a.on("renew",(e=>{console.log("request to renew playerdata (requires identification)",e),onGameUpdate(e)})),a.on("playerRemoved",y),a.on("onGameRestored",(()=>{null===player.teamObj&&m()})),a.on("waitForGame",(()=>{setTimeout((()=>{m()}),1e3)}))},i=()=>`${e}-${o}${n?"-"+r.fid:""}`,d=()=>{localStorage.removeItem(i())},s=a=>{(()=>{const a={hasID:!1};for(let r=0;r<localStorage.length;r++){const l=localStorage.key(r),i=[e,o,...n?[t]:[]];l&&i.every((e=>l.includes(e)))&&(a.hasID=!0,a.key=l,a.value=localStorage.getItem(l))}return a})().hasID||localStorage.setItem(i(),a)},m=()=>{const e=getSocket(),a={game:o,player:t,fake:n,socketID:e.id};e.emit("registerPlayer",a,(e=>{s(e.id);delete window.clone(e).game,e.game&&(e.game=JSON.parse(e.game),e.game.round&&(e.game.round=justNumber(e.game.round)),updateGame(e.game),p(e.game),render(e.renderState))}))},p=e=>{const a=game.teams.findIndex((e=>e.includes(t))),o=(game.persistentData.teamsArray[a],e.playersFull[t]);player?Boolean(player.teamObj)&&Boolean(o.teamObj)&&(player.teamObj.id!==o.teamObj.id||(player.isLead,o.isLead)):console.log("player does not exist"),Object.assign(player,o)},y=e=>{const a=e.game===game.address,o=e.sock===player.socketID,t=e.player===player.id;a&&o&&t&&(d(),$("body").html("I have been removed"),e.alsoClose?window.close():g())},g=()=>{window.location.replace(`${window.location.origin}/removed`)};o=window.location.pathname,o.includes("game-")&&(r.hasOwnProperty("fid")&&(t=window.getQueries().fid),l()),registerClearStorage(d)}));
