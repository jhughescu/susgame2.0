document.addEventListener("DOMContentLoaded",(function(){const e=io("",{query:{role:"systemadmin"}}),s=()=>{const e="a_b_c_d_0",s=[];for(var o=0;o<15;o++)s.push(e.replace("a",o%2).replace("b",o%5).replace("c",Math.round(Math.random()*o%5)).replace("d",Math.round(3*Math.random())));return s.sort(),s};s();const o=()=>{const e=[];for(var s=0;s<30;s++)e.push(`p${s}`);const o=[[],[],[],[],[],[],[]];e.reverse().sort((()=>Math.floor(3*Math.random())-1));for(s=0;s<e.length;s++)o[s%o.length].push(e[s]);return o};document.getElementById("showSessionsForm").addEventListener("submit",(function(e){e.preventDefault(),fetch("/admin/getSessions",{method:"POST",body:new FormData(this)}).then((e=>{if(!e.ok)throw new Error("Failed to generate unique ID");return e.json()})).then((e=>{t("sessions",e)})).catch((e=>{console.error("Error:",e)}))})),document.getElementById("createSessionForm").addEventListener("submit",(function(e){const s=document.getElementById("type"),o=parseInt(s.value);if(o<1||o>1)alert("type must be a number between 1 and 1"),e.preventDefault();else{confirm("are you sure you want to create a new session?")?(e.preventDefault(),fetch("/admin/createSession",{method:"POST",body:JSON.stringify({valType:o}),headers:{"Content-Type":"application/JSON"}}).then((e=>{if(!e.ok)throw new Error("Failed to generate unique ID");return e.json()})).then((e=>{alert(`Created session with uniqueID: ${e.uniqueID}`),n()})).then((()=>{l()})).catch((e=>{console.error("Error:",e)}))):e.preventDefault()}}));const n=s=>{$("#panel_sessions").length>0&&e.emit("getSessionsSock",(e=>{t("sessions",e,(()=>{s&&(a(s),i(s))}))}))},t=(e,s,o)=>{window.renderTemplate("panel","panel",{id:e,content:"sessionPanel"},(()=>{const n=$(`#panel_${e}`);if(n.show(),localStorage.getItem("sessionCardPos")){const e=JSON.parse(localStorage.getItem("sessionCardPos")),s=e.left>20?e.left:20,o=e.top>20?e.top:20;n.css({left:`${s}px`,top:`${o}px`})}n.draggable({stop:function(e,s){const o=s.position;localStorage.setItem("sessionCardPos",JSON.stringify(o))}}),n.find(".close").off("click"),n.find(".close").on("click",(function(){n.find("#sessionList").html(""),n.find("#sessionDetail").html(""),n.hide()})),s.forEach((e=>{e.hasName=e.hasOwnProperty("name")})),window.renderTemplate("sessionList","sessionList",{sessions:s},(()=>{r(),o&&o()}))}))},a=async e=>{const s=$("#verifyPassword").val();fetch("/admin/getSession?sessionID="+e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionID:e,password:s})}).then((e=>{if(!e.ok)throw new Error("Failed to get session data");return e.json()})).then((e=>{$("#sessionDetail").fadeOut(300,(function(){const s=e;s.players.length>10&&(s.players=`${s.players.join(",").substr(0,20)}..`),s.teams.length>0&&(s.teams=s.teams.map((e=>`(${e.length})`))),s.scores.length>0&&(s.scores=`(${s.scores.length} scores recorded)`),s.values.length>0&&(s.values=`(${s.values.length} values recorded)`),s.password&&(s.fdbLink=`${window.location.origin}/facilitatorlogin?s=${s.uniqueID}&p=${s.password}`),window.renderTemplate("sessionDetail","system.card.session",s,c),$("#sessionDetail").fadeIn(300,(()=>{let e=$("#val_password").add($("#val_uniqueID")).add($("#val_fdbLink"));e.addClass("link"),e.off("click").on("click",(function(){const e=$(this).attr("id");copyToClipboard(e)}))}))}))})).catch((e=>{console.error("Error:",e)}))},i=e=>{const s=$(".getSession"),o=$(`#s-link${e}`);s.removeClass("highlight"),o.addClass("highlight")},r=()=>{const e=$(".getSession");e.off("click"),e.on("click",(function(){var e=$(this).data("session-id");i(e),a(e)}))},c=()=>{const s=$("#rename"),o=$("#launch"),t=$("#delete");s.off("click").on("click",(()=>{!async function(){const s=justNumber($("#val_uniqueID").html()),o=prompt(`Enter the new name for ${s}.`),t={gameID:s,name:o};o?e.emit("sessionNameChange",t,(e=>{n(e)})):alert("No name entered.")}()})),o.off("click").on("click",(()=>{!async function(){console.log("facilitate - cookie?");try{const e=$("#val_uniqueID").html(),s=$("#val_password").html(),o=await fetch("/facilitatorlogin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session:e,password:s})});if(!o.ok)throw new Error("Failed to login");o.url,document.cookie=`sessionID=${e}`,window.open("/facilitatordashboard","facdash")}catch(e){console.log("error"),console.log(e)}}()})),t.off("click").on("click",(()=>{!async function(){const s=$("#val_uniqueID").html();if(confirm(`Request to delete session ${s}.\nWARNING: this process deletes the named session from the database. This action cannot be undone.`)){const o=prompt("Enter the system password to continue with deletion.");o&&confirm(`Are you absolutely sure you want to delete session ${s}? This is your last chance to back out...`)&&e.emit("requestSessionDelete",{sID:s,pw:o},(e=>{n(),alert(e.msg)}))}}()}))},l=()=>{$.ajax({method:"GET",url:"/admin/reset-timeout",success:function(e){console.log("Session reset successfully")},error:function(e,s,o){console.error("Error resetting session:",o)}})};e.on("databaseChange",(e=>{console.log("times they are a changing"),console.log(e)})),e.on("gameChange",(e=>{console.log("gameChange"),console.log(e)})),$(document).ready((function(){r(),(()=>{let n=$("#updateSession");n.off("click").on("click",(()=>{e.emit("updateSession",$("#sessionID").val(),{teams:o(),scores:s()})})),n=$("#resetSession"),n.off("click").on("click",(()=>{l()}))})()})),window.readyL=r}));
