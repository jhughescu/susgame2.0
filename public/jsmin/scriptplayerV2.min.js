document.addEventListener("DOMContentLoaded",(function(){let e=null,t=null,a=null,o=null,n="fid",r=null,s=null,l={},i={},c={},m={},d={},p=0,u=!0;const g=()=>500+500*Math.random(),b={note:"homeState setting",temp:"game.main",partialName:"game-links",ob:s,tempType:"homeState",sub:null};let y=JSON.stringify(b);const w=window.getQueries(window.location.href),f="true"===w.fake,O=e=>{let t="";if(s)return t=`ls-${s.id}-${e}`,t},h=()=>z(l,"show game"),S=()=>{e=io(),Z()};setTimeout((()=>{S(),setTimeout((()=>{}),g())}),g());const v=t=>{if($.isEmptyObject(l)?(l=t,window.gameShare(l)):l=Object.assign(l,t),j(z(l,"updated game")),j(l.playersFull),s&&s.hasOwnProperty("index")&&0===s.index){const t=Object.assign({},JSON.parse(JSON.stringify(l)));delete t.persistentData,delete t.presentation;for(let e in t.playersFull)h(),delete t.playersFull[e].teamObj;e.emit("recordthegame",t)}},j=e=>{},k=()=>{console.log("reg with game"),o=a+(w.fake?`-${w[n]}`:"");let r=w.hasOwnProperty(n)?w[n]:f?"":localStorage.getItem(o);const s={game:t,player:r,fake:f,socketID:e.id};window.socketShare(e),e.emit("registerPlayer",s,(t=>{if(console.log("register player callback",t),t){let n=t.id;o=n.indexOf("f",0)>-1?`${a}-${n}`:a,localStorage.setItem(o,n),t.game&&(t.game=JSON.parse(t.game),t.game.round&&(t.game.round=justNumber(t.game.round)),v(t.game),C(t.game)),t.renderState&&(t.renderState.source="registerPlayer event",M(t.renderState),m=t.renderState);let r=window.location.hash;if(r){let e={temptype:"sub"};if(/\d/.test(r)){const t=parseInt(r.match(/\d+/)[0]);e.ob=Object.assign({},l.persistentData.teams[`t${t}`]),delete e.ob.game,r=r.replace(/\d/g,"")}e.temp=`game.${r.replace("#","")}`,M(e)}q((()=>{justNumber(l.round)>0&&G(l.round)})),clearInterval(p),p=setInterval((()=>{u?u=!1:console.log("got disconnected"),e.emit("ping")}),2e3)}}))},D=()=>{let e=null;return localStorage.getItem(o)&&(e=localStorage.getItem(o)),w.hasOwnProperty(n)?w[n]:f?"":e},T=()=>{j("resetPlayer"),M({temp:"game.pending"}),q()},I=()=>{e.emit("getGameCount",(e=>{0===e?Date.now()-r<1e4?setTimeout(I,500):console.log("giving up looking for games"):k()}))},P=()=>{const e=(()=>{const e=l,t=s,a=F(),o={};return e&&(o.gameID=e.uniqueID,o.address=e.address),t&&(o.playerID=t.id,o.socket=t.socketID,t.teamObj&&(o.teamID=t.teamObj.id,o.team=t.teamObj.title)),a&&(o.template=a.temp),o})();let t="<table><tbody>";return Object.entries(e).forEach((e=>{t+=`<tr><td>${e[0]}:</td><td>${e[1]}</td></tr>`})),t+="</tbody></table>",t};let N=null;const E=()=>{1===$("#insertion").find("div").length&&(clearTimeout(N),N=setTimeout(E,200),(()=>{let e=null;return r&&(e=Date.now()-r),e})()/3e3>1&&(clearTimeout(N),console.warn("no content rendered after 3 secs"),$("#insertion").html(`<div id='connectfailmsg'>Sorry, something has gone wrong, please refresh the page to try again.<p>Debug information:</p>${P()}</div>`)))},R=e=>{t=window.location.pathname,a=`${e}-${window.location.pathname}`,r=Date.now(),I(),E()},C=e=>{console.log("setPlayer will create the player object:"),console.log("fgame",e);(e=>{const t=D(),a=e.teams;let o=-1;for(let e=0;e<a.length;e++)if(a[e].includes(t)){o=e;break}e.persistentData.teams[`t${o}`]})(e);const t=e.playersFull[D()];console.log("newPlayer",t),s?(console.log("player exists"),Boolean(s.teamObj)&&Boolean(t.teamObj)&&(s.teamObj.id!==t.teamObj.id||(s.isLead,t.isLead))):console.log("player does not exist"),s=t,console.log(s),window.playerShare(s)},_=()=>{const t={id:D(),sock:"null",stored:"null",teamID:"null",team:"null"};var a,o;e&&(t.sock=e.id),s&&(t.stored=s.socketID,Boolean(s.teamObj)&&(t.teamID=s.teamObj.id,t.team=s.teamObj.title)),a="playerID",o=t,$(".overlay")&&$(".overlay").remove(),window.getTemplate("overlay",{},(e=>{$("body").append(e),window.renderTemplate("overlay",a,o,(()=>{$(".overlay").fadeIn(300)}))}))},J=e=>{const t=`${o}-roundState`;localStorage.setItem(t,e)},L=()=>{const t=$(".yourmove-btn");if(t.length>0&&t.hasClass("disabled")){const o=Object.assign({},i);o.active=!1,o.source="activateYourmove",o.note="set in scriptplayer.js",V(o),t.removeClass("disabled"),t.off("click").on("click",(async()=>{J(!0);await new Promise(((t,a)=>{const o={game:l,playerID:s.id};e.emit("getRenderState",o,(e=>{t(e),M(e);const a=Object.assign({},i);a.active=!0,a.source="yourmove click",a.note="set in scriptplayer.js",V(a),q()}))}))})),console.log("HIGHLIGHT YOURMOVE"),(a=t).jquery||(a=$(`#${a}`)),$("html, body").animate({scrollTop:a.offset().top},300,(()=>{a.data("flashed")||(a.data("flashed",!0),a.fadeOut(100).fadeIn(200).fadeOut(100).fadeIn(200).fadeOut(100).fadeIn(200,(()=>{a.data("flashed",!1)})))}))}var a},B=()=>{if(i.temp&&s&&s.teamObj){const e=i.temp.indexOf("main",0)>-1,t="interaction"===i.tempType,a=l.persistentData.rounds[procVal(l.round)],o=a.type===s.teamObj.type,n=s.teamObj.type,r=a.type,c=1===n?s.teamObj.id:window.justNumber(s.id),m=1===r?"src":"client",d=l.detailedScorePackets.filter((e=>e.round===window.justNumber(l.round))),p=d.filter((e=>e[m]===c)),u={hasScore:p.length>0,scorePackets:d,scorePacket:p};a.n>0&&-1===l.round.toString().indexOf("*",0)&&o&&(u.hasScore||(e||t?e&&L():(U(),q(L))))}},G=async e=>{if(s){await thisRoundScored(s);e.game&&v(e.game);const t=justNumber("object"==typeof e?e.val:e);round=l.persistentData.rounds[t],-1===t&&(M({temp:"game.main",partialName:"game-links"}),q()),round&&round.type===s.teamObj.type&&(console.log("yes, I will activate your move"),B())}},x=async()=>{const t=$(".home_btn");if($.isEmptyObject(d)){const t=await new Promise(((t,a)=>{e.emit("getRenderState",{game:l,playerID:s.id},(e=>{t(e)}))}));t.source="getRenderState event",d=t}t.off("click"),t.on("click",(async()=>{"string"==typeof y&&(y=JSON.parse(y)),console.log("go home",y),U(),J(!1),Y(),q(B);if(l.persistentData.rounds[l.round]){await thisRoundScored()}}))},H=()=>{x();$(".team-link").off("click").on("click",(function(){const e=$(this).attr("id").split("_")[1],t=Object.assign({},l.persistentData.teams[`t${e}`]);t.game={},delete t.game;V({temp:"game.connecton.team",ob:t,preserveOb:!0}),q((()=>{console.log("ok, we can set up the button now")}))}))},A=e=>{switch(e){case"main":(()=>{const e=$(".link_main"),t=($("#link_resources"),$("#link_global")),a=$("#link_connecton");e.off("click"),t.on("click",(()=>{V({temp:"game.global",sub:null,tempType:"sub",ob:{hasContent:!0}}),M({temp:"game.global",sub:null,tempType:"sub",ob:{hasContent:!0}}),Y(),q()})),a.on("click",(()=>{V({temp:"game.connecton",sub:null,tempType:"sub"}),M({temp:"game.connecton",sub:null,tempType:"sub"}),Y(),q()})),B()})();break;case"global":x();break;case"connecton":H();break;case"allocation":window.setupAllocationControl();break;case"collaboration":console.log("setupControl will call setupCollaborationControl"),window.setupCollaborationControl();break;case"vote":window.setupVoteControl();break;case"connecton.team":$("#connecton_btn").off("click").on("click",(()=>{const e={temp:"game.connecton",ob:{},hash:"connecton"};V(e),M(e),q()}))}},F=()=>{let e=(e=>{const t=O(e);return JSON.parse(localStorage.getItem(t))})("renderState");return e&&(e.preserveOb||(e.ob=s),e.source="localStorage"),e},V=e=>{c="string"==typeof e?JSON.parse(e):Object.assign({},e),e&&(e.preserveOb||delete c.ob),c.hasOwnProperty("temp")?((e,t)=>{const a=O(e);localStorage.setItem(a,JSON.stringify(t))})("renderState",window.clone(c)):console.warn("renderState not stored as no 'temp' property found")},M=e=>{if(e){const t=[];Object.assign(i,e);for(let e in i)null===i[e]&&(t.push(e),delete i[e]);Object.assign({},i);delete i.note,V(i)}},U=()=>{V(y),"object"!=typeof y&&(y=JSON.parse(y)),y.ob=s,M(y)},Y=()=>{$("html, body").animate({scrollTop:0},300)},q=e=>{console.log("let's render!");const t=F(),a=l.persistentData.teamsArray;if(i=t||i,"object"==typeof i&&!$.isEmptyObject(i)){const t="game.",n=i.hasOwnProperty("targ")?i.targ:"insertion",r=i.hasOwnProperty("ob")&&void 0!==i.ob?i.ob:{};if(r.game=l,!s)return void console.log("no player, uh-oh");Boolean(s.teamObj)&&(r.renderButton=!s.teamObj.hasLead||s.teamObj.hasLead&&Boolean(s.isLead)),i.hasOwnProperty("partialName")&&(r.partialName=i.partialName),i.tempType&&"interaction"===i.tempType&&((()=>{const e=`${o}-roundState`;let t=localStorage.getItem(e);return t=procVal(t),t})()||U());let c=null;const m=window.filterScorePackets,d=l.scores,p=[],u=window.justNumber;if(r.dynamicTeamData=window.createDynamicTeamData(),d.forEach((e=>{p.push(window.unpackScore(e))})),Boolean(s.teamObj)&&(r.myDynamicTeamData=r.dynamicTeamData[s.teamObj.id]),s.teamObj){r.dynamicSubTeamData=[],r.game.persistentData.secondaryTeams.forEach(((e,t)=>{r.dynamicSubTeamData=r.dynamicSubTeamData.concat(r.game.teams[e.id])})),r.scoresOut=m(p,"src",s.teamObj.id),r.scoresOut1=m(r.scoresOut,"round",1)[0],r.scoresOut3=m(r.scoresOut,"round",3),r.scoresOut3All=[],l.persistentData.mainTeams.forEach(((e,t)=>{r.scoresOut3.filter((t=>t.dest===e.id))[0];let a=p.filter((e=>e.src===s.teamObj.id));a=a.filter((e=>4===e.round)),a=a.filter((t=>t.dest===e.id))[0],r.scoresOut3All[t]=Object.assign({val:a?a.val:0},e)}));const e=window.filterScorePackets(l.detailedScorePackets,"round",l.round);r.dynamicSubTeamData.forEach(((t,a)=>{const o=window.filterScorePackets(e,"client",justNumber(t)).map((e=>e.val));r.dynamicSubTeamData[a]={id:t,votes:o}})),r.myDynamicSubTeamData=r.dynamicSubTeamData.filter((e=>e.id===s.id))[0],r.pv1=m(p,"client",u(s.id)).filter((e=>2===e.round)),r.pv2=m(p,"client",u(s.id)).filter((e=>5===e.round)),r.pv1.forEach(((e,t)=>{r.pv1[t]={title:a[t].title,action:r.dynamicTeamData[t].valuesR1.action,description:r.dynamicTeamData[t].valuesR1.description,val:e.val}})),r.pv2.forEach(((e,t)=>{r.pv2[t]={title:a[t].title,action:r.dynamicTeamData[t].valuesR3.action,description:r.dynamicTeamData[t].valuesR3.description,val:e.val}}))}i.temp&&(c=i.temp.replace(t,"")),delete r.game.playersFull,r.headlines=r.game.persistentData.headlines.slice(0),r.showHeadlines=justNumber(l.slide)>4,r.is2030=window.justNumber(r.game.round)<3,console.log(`render template: ${i.temp}`,r),renderTemplate(n,i.temp,r,(()=>{A(c),e&&e()}))}},Q=e=>JSON.parse(JSON.stringify(e)),z=(e,t)=>{const a=["updateSource"],o=Object.fromEntries(Object.entries(e).filter((([e])=>!a.includes(e))));o._id=t;return K(o)},K=e=>Object.fromEntries(Object.entries(e).sort((([e],[t])=>e.localeCompare(t)))),W=e=>{const t=e.game===l.address,a=e.sock===s.socketID,n=e.player===s.id;t&&a&&n&&(console.log("clearMyStorage",o),localStorage.removeItem(o),M({temp:e.temp}),j("onRemoval"),q())},X=document.getElementById("insertion");new MutationObserver(((e,t)=>{e.forEach((e=>{"childList"===e.type&&$(".home_btn").length>0&&x()}))})).observe(X,{childList:!0});const Z=()=>{e.on("gameUpdate",(e=>{(e=>{const t=e.hasOwnProperty("game")?e.game:e;let a=Boolean(s),o=null;if(e.hasOwnProperty("_updateSource")&&e._updateSource.hasOwnProperty("event")&&s){const n=e._updateSource;switch(o=n.event.split(" ")[1].toLowerCase(),o){case"playerconnectevent":a=s.socketID===n.playerID;break;case"registerplayer":a=s.id===n.playerID;break;case"scoresubmitted":case"presentationaction":default:a=!1;break;case"scoreforaveragesubmitted":a=n.src.player===s.id;break;case"startround":"game.main"!==i.temp&&t.persistentData.rounds[t.round].type!==s.teamObj.type&&(U(),q()),a=!1;case"endround":}}a?(Q(t),v(t),console.log("onGameUpdate"),C(l),q(),B()):v(t)})(e)})),e.on("playerUpdate",(e=>{e.hasOwnProperty("game")&&e.game;e.hasOwnProperty("emitType")})),e.on("test",(()=>{console.log("testing")})),e.on("playerConnect",(e=>{R(e)})),e.on("resetPlayer",T),e.on("teamsAssigned",(e=>{var t;t=e,console.log("teamsAssigned"),console.log(window.clone(t)),console.log(window.clone(s)),v(t),C(t),M({temp:"game.main",ob:s,partialName:"game-links"}),q()})),e.on("teamsReset",(e=>{v(e),M({temp:"game.intro",ob:s}),q()})),e.on("identifyPlayer",(()=>{_()})),e.on("identifySinglePlayer",(e=>{e===s.id&&_()})),e.on("gameOver",(()=>{j("onGameEnd"),localStorage.clear(),M({temp:"game.gameover",ob:{}}),q()})),e.on("renderPlayer",(e=>{const t=e.hasOwnProperty(t)?e.ob:{},a=e.temp;M({temp:a,ob:t}),e.hasOwnProperty("targ")&&(i.targ=e.targ),q()})),e.on("forceRefresh",(()=>{window.location.reload()})),e.on("sendHome",(()=>{U(),q()})),e.on("startRound",(e=>{console.log("startRound heard, ob:",e),G(e)})),e.on("waitForGame",(()=>{})),e.on("playerRemoved",(e=>{W(e)})),e.on("pong",(()=>{u=!0}))};renderTemplate=window.renderTemplate,procVal=window.procVal;window.showHomeState=()=>{console.log("showHomeState",y)},window.showGame=h,window.showPlayer=()=>s,window.activateYourmove=B,window.forceUpdate=()=>{const t={game:l,playerID:s.id};e.emit("getRenderState",t,(e=>{v(e.theGame),M(e),q()}))}}));
