document.addEventListener("DOMContentLoaded",(function(){let e=null,t=null,o=null,n=null;const a={},r={0:"round",1:"src",2:"dest",3:"val",4:"client"},i="You are about to submit your final vote for all teams, this action cannot be undone. Are you sure?",s=async()=>n.hasOwnProperty("isDev")?n.isDev:new Promise(((t,o)=>{e.on("returnDevMode",(e=>{console.log(`the resolver, isDev: ${e}`),t(e)})),e.emit("checkDevMode"),e.on("error",(e=>{console.warn(`checkDevMode error ${e}`),o(e)}))})),l=e=>(/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)||(isNaN(parseInt(e))?"true"===e?e=!0:"false"===e&&(e=!1):e=parseInt(e)),e),c=e=>{if(null!=e){const t=parseInt(e.toString().replace(/^(-)?\D*/g,"$1").replace(/[^\d-]/g,""));return isNaN(t)?0:t}return console.log("no value passed to justNumber"),0},d=(e,t)=>{let o=1,n=void 0===t?3:t;for(let e=0;e<n;e++)o*=10;return Math.round(e*o)/o},u=()=>{fetch("/partials").then((e=>e.json())).then((e=>{const t=e.partials;(async()=>{for(const e in t){const o=await Handlebars.compile(t[e]);Handlebars.registerPartial(e,o)}})()})).catch((e=>{console.error("Error fetching partials:",e)}))},m=e=>e?e.split("\n")[0].replace(/'/g,'"').trim():"";Handlebars.registerHelper("dynamicPartialNO",(e=>{const t=Handlebars.partials[e];if("function"==typeof t){console.log("yep, is a funk");const e=new Handlebars.SafeString(t(this));return console.log(e),e}return console.log("is not a funk"),""})),Handlebars.registerHelper("dynamicPartial",(function(e,t){return Handlebars.partials[e]?new Handlebars.SafeString(Handlebars.partials[e](this)):new Handlebars.SafeString("Partial not found")})),Handlebars.registerHelper("moreThan",(function(e,t,o){return e>t?o.fn(this):o.inverse(this)})),Handlebars.registerHelper("notSameTeam",(function(e,t,o){if(c(e)!==c(t))return o.fn(this)}));const p=e=>{const t=document.getElementById(e),o=document.createRange();o.selectNode(t),window.getSelection().removeAllRanges(),window.getSelection().addRange(o),document.execCommand("copy"),alert("copied to clipboard"),window.getSelection().removeAllRanges()},h=(e,t,o)=>{const n=[];return o=l(o),e.forEach((e=>{e[t]===o&&n.push(e)})),n},w=e=>{const t=e.split("_"),o={};return t.forEach(((e,t)=>{o[r[t]]=c(e)})),o},f=t=>{const a=null===o?t:o;if(e&&a)return new Promise(((t,o)=>{e.emit("getScorePackets",`game-${n.uniqueID}`,(e=>{if(a.teamObj){const o=1===a.teamObj.type?a.teamObj.id:c(a.id),r=1===c(a.teamObj.type)?"src":"client",i=h(e,"round",c(n.round)),s=h(i,r,o),l=e.map((e=>`${e.round}.${e.src}`)),d=`${c(n.round)}.${a.teamObj.id}`,u=l.indexOf(d),m={hasScore:u>-1,scorePacket:e[u],scorePackets:h(e,"round",n.round)};m.hasScore=s.length>0,t(m)}}))}))},b=()=>window.location.hostname.includes("localhost"),g=()=>window.location.href.toLocaleLowerCase().includes("facilitatordashboard"),v=async t=>{"string"!=typeof n.round||n.round.includes("*")||(n.round=parseInt(n.round));const a=null===o?t:o,r=n.persistentData;let i=null;if(a){i=a.teamObj;const t=$("#vote_btn_minus"),o=$("#vote_btn_plus"),l=$(".tempV"),d=$(".remainVal"),u=$("#buttonAllocate"),m=$("#action-choice"),p=$("#actionDesc"),h=$("#vote_btn_minus, #vote_btn_plus, #buttonAllocate, #action-choice, #actionDesc"),w=150,y=await f(a);window.initScoreboard(n.address,a.id,n);window.getScoresSummary()[`r${window.justNumber(i.id)}`];const S=n.detailedScorePackets.filter((e=>e.src===a.teamObj.id)).map((e=>e.val)).reduce(((e,t)=>e+(isNaN(t)?0:t)),0),I=r.teamsArray[i.id].votes-S;d.html(I),b()&&e.emit("getLoremIpsum",7,(e=>{p.val(e),l.html(Math.ceil(Math.random()*(I-2)));let t=$("#action-choice option").map((function(){return $(this).val()})).get().slice(1);m.val(t[Math.floor(Math.random()*t.length)])}));let O=!1;if(O=n.hasOwnProperty("isDev")?n.isDev:await s(),y)if(y.hasScore){const t={gameID:`game-${n.uniqueID}`,team:a.teamObj.id};e.emit("getValues",t,(e=>{h.prop("disabled",!0),h.addClass("disabled"),l.html(y.scorePacket.val),p.html(e.description),m.val(e.action),window.forceUpdate&&forceUpdate()}))}else{h.off("click"),o.on("click",(()=>{let e=parseInt(l.html());e<I&&(e+=1,l.html(e))})),t.on("click",(()=>{let e=parseInt(l.html());e>1&&(e-=1,l.html(e))})),p.on("input",(function(){const e=$(this).val();/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(e)&&alert("Please do not include email addresses."),e.length>=w&&$(this).val(e.substr(0,w-1));const t=`${e.length}/${w}`,o=$(this).parent().find("#moveDescLabel"),n=o.html().replace(/[()/\d-]/g," ").replace(/\s+$/,"");o.html(`${n}   (${t})`)}));let r=O;if(r=!1,r){p.html("Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed lorem felis, lacinia non nibh at, maximus pretium mi. Proin imperdiet velit augue, quis laoreet neque iaculis vitae."),l.html(1+Math.ceil(4*Math.random()));const e=m.find("option").length,t=1+Math.floor(Math.random()*(e-1));m.prop("selectedIndex",t)}u.on("click",(()=>{let t=!0;if(c(l.html())===I&&(t=window.confirm("If you use up all your resources now you may not be able to contribute to subsequent rounds. Are you sure you want to continue?")),t){let t=parseInt(l.html()),o=m.val(),r=p.val();if(0===t||""===o||""===r)alert("Please complete all options and allocate at least 1 resource");else{a.teamObj.id;let i=a.teamObj.id;const s={game:n.uniqueID,values:{team:i,round:parseInt(window.justNumber(n.round)),action:o,description:r}};e.emit("submitValues",s);const l={scoreCode:{src:i,dest:i,val:t},game:n.uniqueID,client:a.id};e.emit("submitScore",l,(t=>{v(),g()&&e.emit("refreshClient",a)}))}}}))}}},y=async t=>{const a=null===o?t:o,r=`votes-${n.address}-${a.id}-r${n.round}`;let s=[],d=[];localStorage.getItem(r)&&(d=localStorage.getItem(r).split(","));l(a.index);const u=c(a.id),m=(await f(a),$(".resources-buttons")),p=$(".resources-btn"),w=$(".vote_btn_minus"),b=$(".vote_btn_plus"),v=$("#vAvail"),S=$("#vTotal"),I=$(".value"),O=$("#buttonAllocate"),j=($(".vote_btn_minus, .vote_btn_plus, #buttonAllocate"),a.teamObj.votes),k=(parseInt(n.round),{gameID:`game-${n.uniqueID}`,round:l(n.round),src:a.teamObj.id});let D=n.detailedScorePackets.filter((e=>e.client===window.justNumber(a.id)));D=D.filter((e=>e.src===a.teamObj.id)),D=D.map((e=>e.val)),D=D.reduce(((e,t)=>e+(isNaN(t)?0:Math.abs(t))),0);const P=j-D;S.html(P),e.emit("getAggregates",k,((t,o,l)=>{const f=h(h(o,"client",u),"round",n.round),j=Boolean(f.length);let k=0,D=0,P=0;I.each(((e,t)=>{const o=parseInt($(t).html());P+=Math.abs(o),D+=o})),localStorage.setItem(r,s.join(","));let _=c(v.html())!==c(S.html());if(j)return w.addClass("disabled"),b.addClass("disabled"),O.addClass("disabled"),w.prop("disabled",!0),b.prop("disabled",!0),O.prop("disabled",!0),I.each(((e,t)=>{$(t).html(f[e].val),k+=f[e].val})),void v.html(Math.abs(k));{s=[],k=0,D=0,P=0,I.each(((e,t)=>{d.length>0&&$(t).html(d[e]);const o=parseInt($(t).html());P+=Math.abs(o),D+=o,s.push(o)})),d.length>0&&v.html(Math.abs(P)),localStorage.setItem(r,s.join(",")),p.off("click").on("click",(function(){I.each(((e,t)=>{k+=c($(t).html())}));let e=0,t=0;const o=$(this).attr("id").indexOf("plus",0)>-1?1:-1;c(S.html()),c(v.html());k=0,I.each(((e,t)=>{k+=c($(t).html())})),k+=o;c(S.html()),c(v.html()),c(S.html()),c(v.html()),Math.abs(o),c(S.html()),c(v.html()),Math.abs(o);const n=$(this).parent().parent().parent().find(".value");let i=parseInt(n.html());i+=o,n.html(i),s=[],I.each(((o,n)=>{const a=parseInt($(n).html());e+=Math.abs(a),t+=a})),localStorage.setItem(r,s.join(",")),v.html(e),y(a)}));let t=P!==c(S.html()),o=0!==D;t=o=!0,_?p.prop("disabled",!1):(w.prop("disabled",!0),b.prop("disabled",!0),m.each(((e,t)=>{const o=$(t),n=o.find(".vote_btn_plus"),a=o.find(".vote_btn_minus"),r=parseInt(o.find(".value").html());0===r?(a.prop("disabled",!0),n.prop("disabled",!0)):r<0?(a.prop("disabled",!0),n.prop("disabled",!1)):(a.prop("disabled",!1),n.prop("disabled",!0))}))),O.off("click").on("click",(()=>{const t={scoreCode:[],game:n.uniqueID,player:a.id};let o=!0;if(v.html()===S.html()&&n.round<5&&(alert("Please keep some of your resources in reserve for subsequent rounds"),o=!1),o){let o=!1,n=!0;I.each(((e,t)=>{0===parseInt($(t).html())&&(o=!0)})),o&&(n=window.confirm(i)),n&&(I.each(((e,o)=>{t.scoreCode.push({src:a.teamObj.id,dest:c($(o).attr("id")),val:parseInt($(o).html()),client:c(a.id)})})),e.emit("submitScoreForAverage",t),localStorage.removeItem(r),y(a),g()?e.emit("refreshClient",a):window.location.reload())}}))}}))},S=async t=>{const a=n.persistentData,r=null===o?t:o,s=r.teamObj,l=`collabs-${n.address}-${r.id}`,d=(e=>{const t=n.scores.map((e=>window.unpackScore(e))),o=n.persistentData.teams[`t${e.teamObj.id}`],a=o.id,r=o.type,i=window.justNumber(n.round);let s=null;if(2===r)s=o.votes;else{s=o.votes;const e=window.filterScorePackets(t,"src",a);for(let t=1;t<i;t++)window.filterScorePackets(e,"round",t).length>0&&(s-=window.filterScorePackets(e,"round",t)[0].val)}return s})(r),u=$("#vAvail"),m=$("#vTotal"),p=($("#vote_btn_minus"),$(".vote_btn_plus"),$(".resources-btn")),h=$(".value"),w=$("#buttonAllocate");let f=[],b=0,v=localStorage.getItem(l),y=!1;const I=n.scores,O=[];I.forEach((e=>{O.push(window.unpackScore(e))})),window.initScoreboard(n.address,r.id,n);window.getScoresSummary()[`r${window.justNumber(s.id)}`];const j=a.teamsArray[s.id].votes;let k=O.filter((e=>e.src===r.teamObj.id));k=k.map((e=>e.val)).reduce(((e,t)=>e+(isNaN(t)?0:t)),0);const D=j-k;e.emit("getScorePackets",n.uniqueID,(t=>{const o=window.filterScorePackets(t,"round",n.round),a=window.filterScorePackets(o,"src",r.teamObj.id);if(y=a.length>0,y)return p.prop("disabled",!0),void w.prop("disabled",!0);{v&&(v=v.split(",")),h.each(((e,t)=>{v&&$(t).html(v[e]);const o=Math.abs(parseInt($(t).html()));b+=o,f.push(o)}));$("#vote_btn_minus, #vote_btn_plus, #buttonAllocate, #action-choice, #actionDesc");const t=!1;r.teamObj.votes=d,u.html(d-(d-b)),m.html(D),h.each(((e,t)=>{const o=0===parseInt($(t).html()),n=parseInt(u.html())===parseInt(m.html());$(t).closest(".resources-buttons").find(".vote_btn_minus").prop("disabled",o),$(t).closest(".resources-buttons").find(".vote_btn_plus").prop("disabled",n)})),t||(p.off("click").on("click",(function(){let e=parseInt(m.html());$(this).attr("id");const t=$(this).parent().find(".value"),o=$(this).attr("id").toLowerCase().includes("plus")?1:-1;e-o>-1&&parseInt(t.html())+o>-1&&(t.html(parseInt(t.html())+o),f=[],h.each(((e,t)=>{const o=Math.abs(parseInt($(t).html()));f.push(o)})),localStorage.setItem(l,f.toString()),S(r))})),w.off("click").on("click",(()=>{const t=r.teamObj.id;let o=!1,a=!0;h.each(((e,t)=>{0===parseInt($(t).html())&&(o=!0)})),o&&(a=window.confirm(i)),h.each(((o,a)=>{const i=c($(a).attr("id")),s=parseInt($(a).html()),l={scoreCode:{src:t,dest:i,val:s,round:c(n.round)},game:n.uniqueID,client:r.id};e.emit("submitScore",l,(e=>{S(r)}))})),g()&&e.emit("refreshClient",r)}))),localStorage.setItem(l,f.toString())}}))};window.showDynamicTeamData=e=>{console.log("dynamicTeamData",e)},window.createDynamicTeamData=()=>{const e={game:n,dynamicTeamData:[]};let t=[];const a=e.game.scores;n.persistentData.teamsArray,n.values;return a.forEach((e=>{t.push(w(e))})),e.game.persistentData.mainTeams.forEach(((n,a)=>{if(n.values=e.game.values.filter((e=>e.team===n.id))[0],n.valuesR1=e.game.values.filter((e=>e.team===n.id)).filter((e=>1===e.round))[0],n.valuesR3=e.game.values.filter((e=>e.team===n.id)).filter((e=>3===e.round))[0],n.scores=t.filter((e=>e.src===n.id))[0],n.scoresR1=t.filter((e=>e.src===n.id)).filter((e=>1===e.round))[0],n.scoresR3=t.filter((e=>e.src===n.id)).filter((e=>3===e.round))[0],n.is2030=c(e.game.round)<3,o){let r=e.game.values.filter((e=>1===e.round)).filter((e=>e.team===a))[0],i=t.filter((e=>2===e.round)).filter((e=>e.dest===a)).filter((e=>e.client===window.justNumber(o.id)));r&&i.length>0&&(n.myPV1={title:n.title,action:r.action,description:r.description,val:i[0].val}),r=e.game.values.filter((e=>3===e.round)).filter((e=>e.team===a))[0],i=t.filter((e=>5===e.round)).filter((e=>e.dest===a)).filter((e=>e.client===window.justNumber(o.id))),r&&i.length>0&&(n.myPV2={title:n.title,action:r.action,description:r.description,val:i[0].val})}e.dynamicTeamData.push(n)})),e.dynamicTeamData};u(),window.procVal=l,window.justNumber=c,window.roundNumber=d,window.roundAll=e=>{for(let t in e)if(isNaN(e[t])||(e[t]=d(e[t])),"object"==typeof e[t])for(let o in e[t])isNaN(e[t][o])||(e[t][o]=d(e[t][o]));return e},window.emitWithPromise=(e,t,o)=>new Promise(((n,a)=>{e.emit(t,o,(e=>{n(e)}))})),window.reorderObject=(e,t)=>{let o={[t]:e[t]};for(let n in e)n!==t&&(o[n]=e[n]);return o},window.loadCSS=e=>{const t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=`css/${e}.css`,document.head.appendChild(t)},window.loadJS=e=>{const t=document.createElement("script");t.type="text/javascript",t.src=`js/${e}.js`,document.head.appendChild(t)},window.isValidJSON=e=>{try{return JSON.parse(e),!0}catch(e){return!1}},window.toCamelCase=e=>e.replace(/(?:^\w|[A-Z]|\b\w)/g,(function(e,t){return 0!==t?e.toLowerCase():e.toUpperCase()})).replace(/\s+/g,""),window.removeTemplate=(e,t)=>{$(e).html(""),t?t():console.warn("no callback provided for removeTemplate method")},window.renderTemplate=(e,t,o,n)=>{if(void 0===o)return void console.error("Error: Data object is undefined");0===e.indexOf("#",0)&&(e=e.replace("#","")),$(`#${e}`).css({opacity:0});const r=m($(`#${e}`).html());if(a.hasOwnProperty(t)){const i=Handlebars.compile(a[t]);if(document.getElementById(e)){const t=m(i(o));(t!==r||t.includes("forceOverwrite"))&&(document.getElementById(e).innerHTML=i(o))}n&&n(),$(`#${e}`).css({opacity:1})}else fetch(`/getTemplate?template=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then((e=>e.text())).then((r=>{const i=r;a[t]=r;const s=Handlebars.compile(i);document.getElementById(e)&&(document.getElementById(e).innerHTML=s(o)),n&&n(),$(`#${e}`).animate({opacity:1})})).catch((e=>{console.error("Error fetching or rendering template:",e)}))},window.renderPartial=(e,t,o,n)=>{if(void 0===o)return void console.error("Error: Data object is undefined");0===e.indexOf("#",0)&&(e=e.replace("#","")),$(`#${e}`).css({opacity:0});const a=Handlebars.partials[t];document.getElementById(e)?document.getElementById(e).innerHTML=a(o):console.warn(`target HTML not found: ${e}`),n&&n(),$(`#${e}`).css({opacity:1})},window.getTemplate=(e,t,o)=>{if(a.hasOwnProperty(e)){const t=a[e];o&&o(t)}else fetch(`/getTemplate?template=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>e.text())).then((t=>{a[e]=t,o&&o(t)})).catch((e=>{console.error("Error fetching or rendering template:",e)}))},window.setupPanel=()=>{console.log("setupPanel")},window.setupObserver=(e,t)=>{const o=document.getElementById(e);if(!o)return void console.error(`Element with ID '${e}' not found.`);new MutationObserver((function(e,o){for(const o of e)"childList"===o.type?t&&t():o.type})).observe(o,{attributes:!0,childList:!0,subtree:!0})},window.copyObjectWithExclusions=(e,t)=>{const o={};for(const n in e)t.includes(n)||(o[n]=e[n]);return o},window.clone=e=>{if(e)return JSON.parse(JSON.stringify(e))},window.copyToClipboard=p,window.createCopyLinks=()=>{$(".copylink").off("click").on("click",(function(){p($(this).attr("id"))}))},window.getQueries=e=>{let t={};if((e=e||window.location.href).indexOf("?",0)>-1){let o=e.split("?")[1];o=o.replace(window.location.hash,""),o=o.split("&"),o.forEach((e=>{e=e.split("="),t[e[0]]=e[1]}))}return t},window.getPartials=u,window.socketShare=(o,n)=>{e=o,t=n},window.getSocket=o=>o===t?e:null,window.playerShare=e=>{o=e},window.gameShare=e=>{n=e},window.thisRoundScored=f,window.unpackScore=w,window.setupAllocationControl=v,window.setupCollaborationControl=S,window.setupVoteControl=y,window.checkDevMode=s,window.sortBy=(e,t,o)=>e.sort(((e,n)=>e[t]<n[t]?o?1:-1:e[t]>n[t]?o?-1:1:0)),window.sortNumber=(e,t)=>e>t?-1:e<t?1:0,window.filterScorePackets=h,window.mapSessionToGame=(e,t)=>{const o=Object.assign({},t);for(let n in t)t.hasOwnProperty(n)&&(o[n]=e[n]);return o},window.isLocal=b}));
